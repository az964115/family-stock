<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ· è±¬è±¬eç¶² - 2026 å…¨åŠŸèƒ½æ•´åˆç‰ˆ</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <style>
    :root {
      --primary-color: #f0a500;
      --bg-color: #fdf6e3;
      --card-bg: #ffffff;
    }
    body { font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; transition: 0.4s; }
    .container { max-width: 900px; margin: 0 auto 25px auto; background: #fff3e0; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { color: #5d4037; border-left: 5px solid var(--primary-color); padding-left: 10px; }
    
    /* ä½ˆå±€çµ„ä»¶ */
    .flex-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    .flex-grow { flex: 1; min-width: 150px; }
    .stat-box { background: #fff7cc; padding: 20px; border-radius: 10px; border-left: 5px solid var(--primary-color); }
    
    /* è¡¨å–®èˆ‡æŒ‰éˆ• */
    input, select, button { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
    button { background: var(--primary-color); color: white; border: none; cursor: pointer; transition: 0.3s; font-weight: bold; }
    button:hover { background: #d88e00; transform: translateY(-2px); }
    .btn-danger { background: #e74c3c; }

    /* åœ–è¡¨å®¹å™¨ */
    .chart-container { position: relative; height: 350px; width: 100%; background: white; border-radius: 10px; padding: 10px; margin-top: 15px; }

    /* åˆ—è¡¨æ¨£å¼ */
    ul { list-style: none; padding: 0; }
    li { background: white; padding: 12px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    
    /* ç‰¹æ®Šæ¨™ç±¤ */
    .gain { color: #e74c3c; font-weight: bold; }
    .loss { color: #2ecc71; font-weight: bold; }
    
    /* éŸ¿æ‡‰å¼ */
    @media (max-width: 600px) {
      .flex-row { flex-direction: column; }
    }
  </style>
</head>
<body>

<div id="loginSection" class="container" style="max-width: 450px;">
  <h2 style="text-align: center; border:none;">ğŸ”‘ ç³»çµ±ç™»å…¥</h2>
  <div style="display: flex; flex-direction: column; gap: 15px;">
    <select id="loginUser">
      <option value="jason">Jason (ç®¡ç†å“¡)</option>
      <option value="mom">åª½åª½ (å®¶è¨ˆ)</option>
      <option value="dad">çˆ¸çˆ¸ (æŠ•è³‡)</option>
    </select>
    <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button onclick="login()">é€²å…¥ç³»çµ±</button>
  </div>
</div>

<div id="mainContent" style="display:none;">
  
  <section class="container">
    <h2>ğŸ“‰ 2026 è³‡ç”¢å¿«ç…§</h2>
    <div class="stat-box">
      <p style="margin:0;">ğŸ’° ç•¶å‰è³‡ç”¢ç¸½ç¾å€¼ï¼š</p>
      <span id="currentNetWorth" style="font-size:2em; color:var(--primary-color); font-weight:bold;">0</span> <small>TWD</small>
      
      <div class="flex-row" style="margin-top:20px; border-top: 1px solid #eee; padding-top: 15px;">
        <div class="flex-grow">
          ğŸš€ <span style="color:#999">ä»Šå¹´è³ºæœ€å¤šï¼š</span><br>
          <strong id="maxGainDay">è¼‰å…¥ä¸­...</strong>
        </div>
        <div class="flex-grow">
          ğŸ“‰ <span style="color:#999">ä»Šå¹´æœ€æ…˜æ—¥ï¼š</span><br>
          <strong id="maxLossDay">è¼‰å…¥ä¸­...</strong>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="profitTrendChart"></canvas>
    </div>

    <h3 style="margin-top:25px;">ğŸ“‹ æ ¸å¿ƒæŒè‚¡ç®¡ç†</h3>
    <ul id="snapshotList"><li>è³‡æ–™è®€å–ä¸­...</li></ul>

    <details style="margin-top:15px; background:rgba(255,255,255,0.5); padding:10px; border-radius:10px;">
      <summary style="cursor:pointer; font-weight:bold;">å¿«é€Ÿæ“ä½œé¸å–® (æ–°å¢/ç´€éŒ„)</summary>
      <div class="flex-row" style="margin-top:15px;">
        <input type="text" id="snapSymbol" placeholder="ä»£è™Ÿ(å¦‚:2330)" style="width:100px;">
        <input type="number" id="snapShares" placeholder="è‚¡æ•¸">
        <input type="number" id="snapCost" placeholder="å‡åƒ¹">
        <button onclick="addPortfolio('snap')">æ–°å¢/æ›´æ–°</button>
      </div>
      <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">
      <div class="flex-row">
        <input type="number" id="dailyProfitAmount" placeholder="æ‰‹å‹•è¼¸å…¥ä»Šæ—¥ç›ˆè™§ (ä¾‹: +5000)">
        <button onclick="recordDailyProfit()">ç´€éŒ„ä»Šæ—¥ç›ˆè™§æ•¸æ“š</button>
      </div>
    </details>
  </section>

  <section class="container">
    <h2>âœï¸ æ¯æ—¥æ”¶æ”¯è¨˜å¸³</h2>
    <div class="flex-row">
      <input type="text" id="expenseDesc" placeholder="æ”¯å‡ºèªªæ˜">
      <input type="number" id="expenseAmount" placeholder="é‡‘é¡">
      <select id="expenseCategory">
        <option value="é£²é£Ÿ">ğŸ” é£²é£Ÿ</option>
        <option value="äº¤é€š">ğŸš— äº¤é€š</option>
        <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
        <option value="æŠ•è³‡">ğŸ“ˆ æŠ•è³‡</option>
      </select>
      <button onclick="saveExpense()">å„²å­˜ç´€éŒ„</button>
    </div>
    <ul id="historyList"></ul>
  </section>

  <section class="container">
    <h2>ğŸ’± å³æ™‚åŒ¯ç‡è½‰æ› (TWD)</h2>
    <div class="flex-row">
      <input type="number" id="twdInput" placeholder="è¼¸å…¥å°å¹£" oninput="convertCurrency()">
      <div class="flex-grow">ğŸ‡ºğŸ‡¸ USD: <span id="usdResult">0.00</span></div>
      <div class="flex-grow">ğŸ‡¯ğŸ‡µ JPY: <span id="jpyResult">0.00</span></div>
    </div>
  </section>

  <div style="text-align: center; margin-bottom: 50px;">
    <button class="btn-danger" onclick="logout()">ğŸšª å®‰å…¨ç™»å‡ºç³»çµ±</button>
  </div>
</div>

<script>
  // Firebase å¯†é‘°èˆ‡åˆå§‹åŒ–
  const firebaseConfig = {
    apiKey: "AIzaSyCGSq-8joudLdCEB954krl3diNqMQXmsxg",
    authDomain: "piggynet-93c33.firebaseapp.com",
    databaseURL: "https://piggynet-93c33-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "piggynet-93c33",
    storageBucket: "piggynet-93c33.appspot.com",
    messagingSenderId: "65171780729",
    appId: "1:65171780729:web:ce5f7272f25a75f43490a8"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
  let currentUser = "";
  let trendChart = null;

  // --- ç³»çµ±æ ¸å¿ƒåŠŸèƒ½ ---

  function login() {
    const user = document.getElementById('loginUser').value;
    const pass = document.getElementById('loginPassword').value;
    if(pass) { // é€™è£¡æ‚¨å¯ä»¥å¢åŠ æ›´åš´è¬¹çš„å¯†ç¢¼åˆ¤æ–·
      currentUser = user;
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      initializeData();
    } else {
      alert("è«‹è¼¸å…¥å¯†ç¢¼");
    }
  }

  function logout() { location.reload(); }

  function initializeData() {
    loadPortfolio();
    loadExpenses();
    updateSnapshotStats();
    convertCurrency();
  }

  // --- A. æŠ•è³‡èˆ‡å¿«ç…§é‚è¼¯ ---

  async function loadPortfolio() {
    const ref = db.ref(`users/${currentUser}/portfolio`);
    ref.on('value', async (snapshot) => {
      const data = snapshot.val() || {};
      const list = document.getElementById('snapshotList');
      list.innerHTML = "";
      let totalNetWorth = 0;

      for (const [symbol, info] of Object.entries(data)) {
        let price = info.cost; 
        try {
          const res = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY_AVG_ALL`);
          const stocks = await res.json();
          const target = stocks.find(s => s.Code === symbol);
          if(target) price = parseFloat(target.ClosingPrice);
        } catch(e) { console.log("ç„¡æ³•å–å¾—å³æ™‚åŒ¯ç‡ï¼Œä½¿ç”¨æˆæœ¬åƒ¹"); }

        const marketValue = price * info.shares;
        totalNetWorth += marketValue;

        const li = document.createElement('li');
        li.innerHTML = `
          <span><strong>${symbol}</strong> - ${info.shares} è‚¡</span>
          <span>å¸‚å€¼: ${Math.round(marketValue).toLocaleString()} å…ƒ</span>
          <button class="btn-danger" onclick="deleteStock('${symbol}')">åˆªé™¤</button>
        `;
        list.appendChild(li);
      }
      document.getElementById('currentNetWorth').textContent = Math.round(totalNetWorth).toLocaleString();
    });
  }

  function addPortfolio() {
    const sym = document.getElementById('snapSymbol').value;
    const sha = parseFloat(document.getElementById('snapShares').value);
    const cos = parseFloat(document.getElementById('snapCost').value);
    if(!sym || !sha) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
    
    db.ref(`users/${currentUser}/portfolio/${sym}`).set({
      shares: sha, cost: cos, lastUpdate: Date.now()
    });
  }

  function deleteStock(symbol) {
    if(confirm(`ç¢ºå®šåˆªé™¤ ${symbol} å—ï¼Ÿ`)) {
      db.ref(`users/${currentUser}/portfolio/${symbol}`).remove();
    }
  }

  function recordDailyProfit() {
    const amount = parseFloat(document.getElementById('dailyProfitAmount').value);
    if(isNaN(amount)) return alert("è«‹è¼¸å…¥æ•¸å­—");
    const today = new Date().toISOString().split('T')[0];
    
    db.ref(`users/${currentUser}/dailyProfits/${today}`).set(amount).then(() => {
      alert("ç´€éŒ„æˆåŠŸ");
      updateSnapshotStats();
    });
  }

  function updateSnapshotStats() {
    db.ref(`users/${currentUser}/dailyProfits`).on('value', snap => {
      const data = snap.val() || {};
      const entries = Object.entries(data).sort();
      if(entries.length === 0) return;

      let maxGain = { day: 'ç„¡', val: -Infinity };
      let maxLoss = { day: 'ç„¡', val: Infinity };

      entries.forEach(([day, val]) => {
        if(val > maxGain.val) maxGain = { day, val };
        if(val < maxLoss.val) maxLoss = { day, val };
      });

      document.getElementById('maxGainDay').innerHTML = `${maxGain.day} <span class="gain">(+${maxGain.val.toLocaleString()})</span>`;
      document.getElementById('maxLossDay').innerHTML = `${maxLoss.day} <span class="loss">(${maxLoss.val.toLocaleString()})</span>`;
      
      renderTrendChart(entries);
    });
  }

  function renderTrendChart(entries) {
    const ctx = document.getElementById('profitTrendChart').getContext('2d');
    if(trendChart) trendChart.destroy();
    
    trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: entries.map(e => e[0].substring(5)), // åªå– æœˆ-æ—¥
        datasets: [{
          label: 'æç›Šèµ°å‹¢',
          data: entries.map(e => e[1]),
          borderColor: '#f0a500',
          tension: 0.4,
          fill: true,
          backgroundColor: 'rgba(240, 165, 0, 0.1)'
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  // --- B. è¨˜å¸³é‚è¼¯ ---

  function saveExpense() {
    const desc = document.getElementById('expenseDesc').value;
    const amt = document.getElementById('expenseAmount').value;
    const cat = document.getElementById('expenseCategory').value;
    if(!desc || !amt) return;

    db.ref(`users/${currentUser}/expenses`).push({
      desc, amt: parseFloat(amt), cat, time: Date.now()
    });
    document.getElementById('expenseDesc').value = "";
    document.getElementById('expenseAmount').value = "";
  }

  function loadExpenses() {
    db.ref(`users/${currentUser}/expenses`).limitToLast(10).on('value', snap => {
      const list = document.getElementById('historyList');
      list.innerHTML = "";
      snap.forEach(child => {
        const item = child.val();
        const li = document.createElement('li');
        li.innerHTML = `<span>${item.cat} | ${item.desc}</span> <b>-$${item.amt}</b>`;
        list.appendChild(li);
      });
    });
  }

  // --- C. åŒ¯ç‡è½‰æ› ---
  async function convertCurrency() {
    const twd = document.getElementById('twdInput').value;
    if(!twd) return;
    try {
      // ä½¿ç”¨å…è²» API ä½œç‚ºç¯„ä¾‹
      const res = await fetch(`https://open.er-api.com/v6/latest/TWD`);
      const rateData = await res.json();
      document.getElementById('usdResult').textContent = (twd * rateData.rates.USD).toFixed(2);
      document.getElementById('jpyResult').textContent = (twd * rateData.rates.JPY).toFixed(2);
    } catch(e) {
      console.log("åŒ¯ç‡ API é™åˆ¶");
    }
  }

</script>
</body>
</html>
