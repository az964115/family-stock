<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f0a500">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ·è±¬è±¬eç¶²ğŸ·</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 20px; max-width: 900px;
      background-color: #fdf6e3; color: #333;
      transition: background-color 0.4s, color 0.4s;
    }
    .container {
      background: #fff3e0; border-radius: 10px; padding: 20px;
      margin-bottom: 25px; box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    }
    button {
      cursor: pointer; padding: 8px 14px; font-size: 16px;
      border-radius: 5px; border: none; background-color: #f0a500; color: #fff;
      transition: 0.3s;
    }
    button:hover { background-color: #d88e00; }
    input, select, textarea {
      padding: 8px; font-size: 16px; border: 1px solid #ccc; 
      border-radius: 5px; width: 100%; box-sizing: border-box;
    }
    .flex-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
    .flex-grow { flex-grow: 1; min-width: 200px; }
    .stat-box {
      background: #fff7cc; padding: 15px; border-radius: 8px;
      margin-top: 10px; box-shadow: inset 0 0 6px #f0a500aa; font-weight: 600;
    }
    ul { list-style: none; padding: 0; background: #fff; border-radius: 6px; }
    ul li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    
    body.theme-night { background-color: #121212; color: #eee; }
    body.theme-night .container { background: #1e1e1e; color: #eee; }
    body.theme-night .stat-box { color: #333; }
    .chart-container { position: relative; height: 250px; width: 100%; margin-top: 15px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>

  <div id="loginSection" class="container" style="max-width:400px; margin: 40px auto;">
    <h2>ğŸ‘¤ ä½¿ç”¨è€…ç™»å…¥</h2>
    <select id="loginUser">
      <option value="mom">åª½åª½</option>
      <option value="dad">çˆ¸çˆ¸</option>
      <option value="debby">å¦¹å¦¹</option>
      <option value="jason">Jason</option>
    </select>
    <input type="password" id="loginPassword" placeholder="è¼¸å…¥å¯†ç¢¼" style="margin-top:10px;">
    <button onclick="login()" style="width:100%; margin-top:15px;">ç™»å…¥</button>
  </div>

  <div id="mainContent" style="display:none;">
    <div style="text-align: right; margin-bottom: 10px;">
      <span id="userNameDisplay" style="margin-right: 10px; font-weight: bold;"></span>
      <button onclick="setTheme('day')">ğŸŒ</button>
      <button onclick="setTheme('night')">ğŸŒ™</button>
      <button onclick="logout()">ğŸšª ç™»å‡º</button>
    </div>

    <section class="container">
      <h2>ğŸ’° 2026 è³‡ç”¢å¿«ç…§</h2>
      
      <div style="background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #f0a500; margin-bottom: 15px;">
        <label>ğŸ“ æ‰‹å‹•è¼¸å…¥ä»Šæ—¥ç¸½ç›ˆé¤˜ï¼š</label>
        <div class="flex-row" style="margin-top: 8px;">
          <input type="number" id="manualProfitInput" placeholder="è¼¸å…¥é‡‘é¡ (ä¾‹å¦‚: 5000)">
          <button onclick="saveManualProfit()">ğŸ’¾ å„²å­˜ä»Šæ—¥ç›ˆé¤˜</button>
        </div>
      </div>

      <div class="stat-box">
        <p>ğŸ“Š ç•¶å‰ç›ˆé¤˜ï¼š<span id="currentProfitDisplay" style="font-size:1.5em;color:#f0a500;">0</span> å…ƒ</p>
        <div class="flex-row">
          <div class="flex-grow">ğŸš€ æ­·å²è³ºæœ€å¤šï¼š<br><small id="maxGainDay">è®€å–ä¸­...</small></div>
          <div class="flex-grow">ğŸ“‰ æ­·å²æœ€æ…˜æ—¥ï¼š<br><small id="maxLossDay">è®€å–ä¸­...</small></div>
        </div>
      </div>
      <div class="chart-container"><canvas id="profitTrendChart"></canvas></div>
    </section>

    <section class="container">
      <h2>ğŸ’¼ æˆ‘çš„æŠ•è³‡çµ„åˆ</h2>
      <div class="flex-row">
        <input type="text" id="pfSymbol" placeholder="è‚¡è™Ÿ" style="flex:1">
        <input type="number" id="pfShares" placeholder="è‚¡æ•¸" style="flex:1">
        <input type="number" id="pfCost" placeholder="æˆæœ¬" style="flex:1">
        <button onclick="addPortfolio()">æ–°å¢</button>
      </div>
      <ul id="portfolioList" style="margin-top:10px;"></ul>
    </section>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCGSq-8joudLdCEB954krl3diNqMQXmsxg",
      authDomain: "piggynet-93c33.firebaseapp.com",
      databaseURL: "https://piggynet-93c33-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "piggynet-93c33",
      storageBucket: "piggynet-93c33.appspot.com",
      messagingSenderId: "65171780729",
      appId: "1:65171780729:web:ce5f7272f25a75f43490a8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let profitChartInstance = null;

    // ç™»å…¥é‚è¼¯
    async function login() {
      const user = document.getElementById('loginUser').value;
      const pass = document.getElementById('loginPassword').value.trim();
      const snap = await db.ref(`users/${user}/password`).get();
      const stored = snap.exists() ? snap.val() : "9527";
      if (pass === stored) { 
        localStorage.setItem('currentUser', user); 
        location.reload(); 
      } else {
        alert("å¯†ç¢¼éŒ¯èª¤");
      }
    }

    function logout() { 
      localStorage.removeItem('currentUser'); 
      location.reload(); 
    }

    window.onload = () => {
      const user = localStorage.getItem('currentUser');
      if (user) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('userNameDisplay').textContent = `Hi, ${user}`;
        initApp(user);
      }
    };

    function initApp(user) {
      loadPortfolio(user);
      loadAnnualReview(user);
    }

    // æ‰‹å‹•å„²å­˜ç›ˆé¤˜åˆ° Firebase
    function saveManualProfit() {
      const user = localStorage.getItem('currentUser');
      const amount = parseFloat(document.getElementById('manualProfitInput').value);
      if (isNaN(amount)) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—");
        return;
      }
      const today = new Date().toISOString().split('T')[0];
      
      db.ref(`family/investSnapshot/${user}/${today}`).set({ 
        profit: Math.round(amount) 
      }).then(() => {
        alert("å„²å­˜æˆåŠŸï¼");
        document.getElementById('manualProfitInput').value = "";
        loadAnnualReview(user);
      });
    }

    function loadPortfolio(user) {
      db.ref(`users/${user}/portfolio`).on('value', snap => {
        const data = snap.val() || {};
        document.getElementById('portfolioList').innerHTML = Object.entries(data).map(([c, i]) => 
          `<li><b>${c}</b> | ${i.shares}è‚¡ | æˆæœ¬:${i.cost}</li>`
        ).join('');
      });
    }

    function addPortfolio() {
      const user = localStorage.getItem('currentUser');
      const code = document.getElementById('pfSymbol').value;
      const shares = parseFloat(document.getElementById('pfShares').value);
      const cost = parseFloat(document.getElementById('pfCost').value);
      if(code && shares) db.ref(`users/${user}/portfolio/${code}`).set({ shares, cost });
    }

    function loadAnnualReview(user) {
      db.ref(`family/investSnapshot/${user}`).on("value", snap => {
        const allEntries = Object.entries(snap.val() || {})
          .map(([d,v])=>({date:d, profit:v.profit}))
          .sort((a,b)=>new Date(a.date)-new Date(b.date));

        if (!allEntries.length) return;

        // é¡¯ç¤ºæœ€å¾Œä¸€æ¬¡è¼¸å…¥çš„ç›ˆé¤˜
        const latest = allEntries[allEntries.length - 1];
        document.getElementById("currentProfitDisplay").textContent = latest.profit.toLocaleString();

        const chartEntries = allEntries.slice(-30);
        const max = allEntries.reduce((p,c)=>c.profit > p.profit ? c : p);
        const min = allEntries.reduce((p,c)=>c.profit < p.profit ? c : p);

        document.getElementById("maxGainDay").innerHTML =
          `${max.date}<br><span style="color:red;">$${max.profit.toLocaleString()}</span>`;

        document.getElementById("maxLossDay").innerHTML =
          `${min.date}<br><span style="color:green;">$${min.profit.toLocaleString()}</span>`;

        renderChart(chartEntries);
      });
    }

    function renderChart(entries) {
      const ctx = document.getElementById('profitTrendChart').getContext('2d');
      if (profitChartInstance) profitChartInstance.destroy();

      profitChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: entries.map(e => e.date.substring(5)),
          datasets: [{
            label: 'å€‹äººç›ˆé¤˜è¶¨å‹¢',
            data: entries.map(e => e.profit),
            borderColor: '#f0a500',
            backgroundColor: 'rgba(240, 165, 0, 0.2)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    function setTheme(mode) {
      document.body.className = 'theme-' + mode;
      localStorage.setItem('themeMode', mode);
    }
  </script>
</body>
</html>
