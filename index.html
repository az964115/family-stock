<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f0a500">
  <title>ğŸ·è±¬è±¬eç¶² 2026ğŸ·</title>
  
  <style>
    /* --- åŸºç¤æ¨£å¼ --- */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 20px;
      max-width: 900px; margin: auto;
      background-color: #fdf6e3; color: #333;
      transition: background-color 0.4s, color 0.4s;
    }
    .container {
      background: #fff3e0; border-radius: 10px; padding: 20px;
      margin-bottom: 25px; box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    }
    h1, h2, h3 { margin-top: 0; color: #d88e00; }
    
    /* --- æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† --- */
    button {
      cursor: pointer; padding: 8px 14px; border-radius: 5px; border: none;
      background-color: #f0a500; color: #fff; font-weight: bold;
      transition: background-color 0.3s; margin: 4px 2px;
    }
    button:hover { background-color: #d88e00; }
    input, select, textarea {
      padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;
      width: 100%; box-sizing: border-box;
    }

    /* --- åŠŸèƒ½å…ƒä»¶ --- */
    .announcement {
      background-color: #fff8dc; border-left: 5px solid #f0a500;
      padding: 12px 15px; font-weight: bold; border-radius: 6px; margin-bottom: 15px;
    }
    .stat-box {
      background: #fff7cc; padding: 15px; border-radius: 8px;
      box-shadow: inset 0 0 6px #f0a500aa; margin-top: 10px;
    }
    .flex-row { display: flex; gap: 15px; flex-wrap: wrap; }
    .flex-grow { flex-grow: 1; min-width: 200px; }
    
    /* --- åˆ—è¡¨æ¨£å¼ --- */
    ul { list-style: none; padding: 0; background: #fff; border-radius: 6px; }
    ul li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    
    /* --- åœ–è¡¨å®¹å™¨ --- */
    .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; }

    /* --- é é¦–æŒ‰éˆ• --- */
    .top-right { position: sticky; top: 10px; display: flex; justify-content: flex-end; gap: 8px; z-index: 100; margin-bottom: 10px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="loginSection" class="container" style="max-width:400px; margin: 100px auto;">
  <h2 style="text-align: center;">ğŸ‘¤ ä½¿ç”¨è€…ç™»å…¥</h2>
  <label>èª°è¦ç™»å…¥ï¼Ÿ</label>
  <select id="loginUser">
    <option value="mom">åª½åª½</option>
    <option value="dad">çˆ¸çˆ¸</option>
    <option value="debby">å¦¹å¦¹</option>
    <option value="jason">Jason</option>
  </select>
  <label>å¯†ç¢¼</label>
  <input type="password" id="loginPassword" placeholder="è¼¸å…¥å¯†ç¢¼" />
  <button onclick="login()" style="width: 100%; padding: 12px;">ç™»å…¥</button>
</div>

<div id="mainContent" style="display:none;">
  <div class="top-right">
    <button onclick="logout()">ğŸšª ç™»å‡º</button>
  </div>

  <div class="header">
    <h1>ğŸ· è±¬è±¬eç¶² 2026</h1>
    <div class="announcement">ğŸ“¢ è¨˜å¸³èˆ‡æŠ•è³‡è¿½è¹¤ç³»çµ±å·²å°±ç·’</div>
  </div>

  <div id="milestoneAlert" class="announcement" style="display:none; background:#e1f5fe; border-left-color:#03a9f4;">
    ğŸ¯ <b>ç›®æ¨™é”æˆæé†’ï¼š</b><span id="milestoneText"></span>
  </div>

  <section class="container">
    <h2>ğŸ’¬ å®¶åº­ç•™è¨€æ¿</h2>
    <div id="boardMessages" style="max-height:150px; overflow-y:auto; margin-bottom:10px; background:white; padding:10px; border-radius:5px;"></div>
    <div class="flex-row">
      <input type="text" id="boardInput" placeholder="æƒ³èªªä»€éº¼..." style="flex:1;">
      <button onclick="postMessage()">é€å‡º</button>
    </div>
  </section>

  <section class="container">
    <h2>ğŸ“‰ 2026 è³‡ç”¢å¿«ç…§</h2>
    <div class="stat-box">
      <p>ğŸ’° ç•¶å‰è³‡ç”¢ç¸½ç¾å€¼ï¼š<span id="currentNetWorth" style="font-size:1.5em; color:#f0a500; font-weight:bold;">0</span> å…ƒ</p>
      <div class="flex-row" style="margin-top:10px;">
        <div class="flex-grow">ğŸš€ ä»Šå¹´è³ºæœ€å¤šï¼š<br><small id="maxGainDay">è®€å–ä¸­...</small></div>
        <div class="flex-grow">ğŸ“‰ ä»Šå¹´æœ€æ…˜æ—¥ï¼š<br><small id="maxLossDay">è®€å–ä¸­...</small></div>
      </div>
    </div>
    
    <div class="chart-container">
      <canvas id="profitTrendChart"></canvas>
    </div>

    <h3 style="margin-top:20px;">ğŸ“‹ æŒè‚¡æ¸…å–®</h3>
    <ul id="portfolioList"><li>è¼‰å…¥ä¸­...</li></ul>
    
    <details style="margin-top:10px;">
      <summary>â• æ–°å¢æŒè‚¡/ä»Šæ—¥ç›ˆè™§</summary>
      <div class="flex-row" style="margin-top:10px;">
        <input type="text" id="pfSymbol" placeholder="ä»£è™Ÿ" style="width:80px;">
        <input type="number" id="pfShares" placeholder="è‚¡æ•¸">
        <input type="number" id="pfCost" placeholder="æˆæœ¬">
        <button onclick="addPortfolio()">æ–°å¢æŒè‚¡</button>
      </div>
      <hr>
      <div class="flex-row">
        <input type="number" id="dailyProfitInput" placeholder="ä»Šæ—¥ç¸½ç›ˆè™§é‡‘é¡ (å¦‚:+5000)">
        <button onclick="saveDailyProfit()">ç´€éŒ„ä»Šæ—¥ç›ˆè™§</button>
      </div>
    </details>
  </section>

  <section class="container">
    <h2>ğŸ”” 2026 é”æ¨™æé†’è¨­å®š</h2>
    <div class="flex-row">
      <input type="text" id="targetLabel" placeholder="ç›®æ¨™åç¨± (å¦‚: 0050 å­˜æ»¿ 10 å¼µ)">
      <input type="number" id="targetValue" placeholder="ç›®æ¨™ç¸½ç¾å€¼é‡‘é¡">
      <button onclick="setMilestone()">è¨­å®šç›®æ¨™</button>
    </div>
  </section>
</div>

<script>
  // --- Firebase é…ç½® ---
  const firebaseConfig = {
    apiKey: "AIzaSyCGSq-8joudLdCEB954krl3diNqMQXmsxg",
    authDomain: "piggynet-93c33.firebaseapp.com",
    databaseURL: "https://piggynet-93c33-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "piggynet-93c33",
    storageBucket: "piggynet-93c33.appspot.com",
    messagingSenderId: "65171780729",
    appId: "1:65171780729:web:ce5f7272f25a75f43490a8"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const USERS = { mom: "me", dad: "dt", debby: "dua", jason: "952" };
  
  let profitChart = null;

  // --- ç™»å…¥é‚è¼¯ ---
  async function login() {
    const user = document.getElementById('loginUser').value;
    const pass = document.getElementById('loginPassword').value.trim();
    const snap = await db.ref(`users/${user}/password`).get();
    const correctPass = snap.exists() ? snap.val() : USERS[user];

    if (pass === correctPass) {
      localStorage.setItem('currentUser', user);
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      startSystem(user);
    } else {
      alert('å¯†ç¢¼éŒ¯èª¤ï¼');
    }
  }

  function logout() {
    localStorage.removeItem('currentUser');
    location.reload();
  }

  // --- ç³»çµ±å•Ÿå‹• ---
  function startSystem(user) {
    loadBoard();
    loadPortfolio();
    loadAnnualReview();
    calculateNetWorth();
    // æ¯ 10 åˆ†é˜è‡ªå‹•æ›´æ–°ä¸€æ¬¡ç¾å€¼
    setInterval(calculateNetWorth, 600000);
  }

  // --- ç•™è¨€æ¿åŠŸèƒ½ ---
  function loadBoard() {
    db.ref("family/board").limitToLast(10).on("value", snap => {
      const box = document.getElementById("boardMessages");
      box.innerHTML = "";
      snap.forEach(child => {
        const m = child.val();
        box.innerHTML += `<div><b>${m.user}:</b> ${m.msg} <small style="color:#999">${new Date(m.time).toLocaleTimeString()}</small></div>`;
      });
      box.scrollTop = box.scrollHeight;
    });
  }

  function postMessage() {
    const msg = document.getElementById("boardInput").value.trim();
    if (!msg) return;
    db.ref("family/board").push({
      user: localStorage.getItem("currentUser"),
      msg: msg,
      time: Date.now()
    });
    document.getElementById("boardInput").value = "";
  }

  // --- æŠ•è³‡åŠŸèƒ½ ---
  async function calculateNetWorth() {
    const user = localStorage.getItem('currentUser');
    const snap = await db.ref(`users/${user}/portfolio`).get();
    const data = snap.val() || {};
    let total = 0;

    for (const [code, info] of Object.entries(data)) {
      try {
        const res = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&stockNo=${code}`);
        const stock = await res.json();
        if (stock.stat === "OK") {
          const price = parseFloat(stock.data[stock.data.length - 1][6].replace(/,/g, ""));
          total += (price * info.shares);
        }
      } catch (e) { console.error(e); }
    }
    document.getElementById("currentNetWorth").textContent = Math.round(total).toLocaleString();
    checkMilestones(total);
  }

  function loadPortfolio() {
    const user = localStorage.getItem('currentUser');
    db.ref(`users/${user}/portfolio`).on("value", snap => {
      const list = document.getElementById("portfolioList");
      list.innerHTML = "";
      snap.forEach(child => {
        const code = child.key;
        const info = child.val();
        list.innerHTML += `<li><b>${code}</b> ï½œ ${info.shares}è‚¡ ï½œ æˆæœ¬:${info.cost} <button onclick="removePortfolio('${code}')">åˆªé™¤</button></li>`;
      });
    });
  }

  function addPortfolio() {
    const user = localStorage.getItem('currentUser');
    const code = document.getElementById('pfSymbol').value;
    const shares = document.getElementById('pfShares').value;
    const cost = document.getElementById('pfCost').value;
    if(!code || !shares) return;
    db.ref(`users/${user}/portfolio/${code}`).set({ shares: parseInt(shares), cost: parseFloat(cost) });
  }

  function removePortfolio(code) {
    const user = localStorage.getItem('currentUser');
    if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) db.ref(`users/${user}/portfolio/${code}`).remove();
  }

  // --- ç›ˆè™§ç´€éŒ„èˆ‡åœ–è¡¨ ---
  function saveDailyProfit() {
    const user = localStorage.getItem('currentUser');
    const profit = parseFloat(document.getElementById('dailyProfitInput').value);
    const today = new Date().toISOString().split('T')[0];
    if (isNaN(profit)) return;
    db.ref(`users/${user}/dailyProfit/${today}`).set(profit).then(() => alert('ç´€éŒ„æˆåŠŸ'));
  }

  function loadAnnualReview() {
    const user = localStorage.getItem('currentUser');
    db.ref(`users/${user}/dailyProfit`).on('value', snap => {
      const data = snap.val() || {};
      const entries = Object.entries(data).sort((a, b) => new Date(a[0]) - new Date(b[0]));
      if (entries.length === 0) return;

      const maxGain = entries.reduce((prev, curr) => curr[1] > prev[1] ? curr : prev);
      const maxLoss = entries.reduce((prev, curr) => curr[1] < prev[1] ? curr : prev);
      document.getElementById("maxGainDay").textContent = `${maxGain[0]} (+$${maxGain[1]})`;
      document.getElementById("maxLossDay").textContent = `${maxLoss[0]} ($${maxLoss[1]})`;

      updateChart(entries);
    });
  }

  function updateChart(entries) {
    const ctx = document.getElementById('profitTrendChart').getContext('2d');
    if (profitChart) profitChart.destroy();
    profitChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: entries.map(e => e[0]),
        datasets: [{ label: 'æ¯æ—¥ç›ˆè™§', data: entries.map(e => e[1]), borderColor: '#f0a500', fill: false }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  // --- ç›®æ¨™æé†’ ---
  function setMilestone() {
    const user = localStorage.getItem('currentUser');
    const label = document.getElementById('targetLabel').value;
    const target = parseFloat(document.getElementById('targetValue').value);
    db.ref(`users/${user}/milestones`).set({ label, target });
    alert('ç›®æ¨™å·²è¨­å®šï¼');
  }

  function checkMilestones(currentTotal) {
    const user = localStorage.getItem('currentUser');
    db.ref(`users/${user}/milestones`).once('value', snap => {
      const goal = snap.val();
      if (goal && currentTotal >= goal.target) {
        document.getElementById("milestoneAlert").style.display = "block";
        document.getElementById("milestoneText").textContent = goal.label;
      }
    });
  }
</script>
</body>
</html>