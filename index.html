<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f0a500">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ·è±¬è±¬eç¶²ğŸ·</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 20px; max-width: 900px;
      background-color: #fdf6e3; color: #333;
      transition: background-color 0.4s, color 0.4s;
    }
    .container {
      background: #fff3e0; border-radius: 10px; padding: 20px;
      margin-bottom: 25px; box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    }
    button {
      cursor: pointer; padding: 8px 14px; font-size: 16px;
      border-radius: 5px; border: none; background-color: #f0a500; color: #fff;
      transition: 0.3s;
    }
    button:hover { background-color: #d88e00; }
    input, select, textarea {
      padding: 8px; font-size: 16px; border: 1px solid #ccc; 
      border-radius: 5px; width: 100%; box-sizing: border-box;
    }
    .flex-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
    .flex-grow { flex-grow: 1; min-width: 200px; }
    .stat-box {
      background: #fff7cc; padding: 15px; border-radius: 8px;
      margin-top: 10px; box-shadow: inset 0 0 6px #f0a500aa; font-weight: 600;
    }
    ul { list-style: none; padding: 0; background: #fff; border-radius: 6px; }
    ul li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    
    body.theme-night { background-color: #121212; color: #eee; }
    body.theme-night .container { background: #1e1e1e; color: #eee; }
    body.theme-night .stat-box { color: #333; }
    .chart-container { position: relative; height: 250px; width: 100%; margin-top: 15px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>

  <div id="loginSection" class="container" style="max-width:400px; margin: 40px auto;">
    <h2>ğŸ‘¤ ä½¿ç”¨è€…ç™»å…¥</h2>
    <select id="loginUser">
      <option value="mom">åª½åª½</option>
      <option value="dad">çˆ¸çˆ¸</option>
      <option value="debby">å¦¹å¦¹</option>
      <option value="jason">Jason</option>
    </select>
    <input type="password" id="loginPassword" placeholder="è¼¸å…¥å¯†ç¢¼" style="margin-top:10px;">
    <button onclick="login()" style="width:100%; margin-top:15px;">ç™»å…¥</button>
  </div>

  <div id="mainContent" style="display:none;">
    <div style="text-align: right; margin-bottom: 10px;">
      <button onclick="setTheme('day')">ğŸŒ ç™½å¤©</button>
      <button onclick="setTheme('night')">ğŸŒ™ é»‘å¤œ</button>
      <button onclick="logout()">ğŸšª ç™»å‡º</button>
    </div>

    <section class="container">
      <h2>ğŸ’° 2026 è³‡ç”¢å¿«ç…§</h2>
      <div class="stat-box">
        <p>ğŸ’° ç•¶å‰è³‡ç”¢ç¾å€¼ï¼š<span id="currentNetWorth" style="font-size:1.5em;color:#f0a500;">0</span> å…ƒ</p>
        <div class="flex-row">
          <div class="flex-grow">ğŸš€ ä»Šå¹´è³ºæœ€å¤šï¼š<br><small id="maxGainDay">è®€å–ä¸­...</small></div>
          <div class="flex-grow">ğŸ“‰ ä»Šå¹´æœ€æ…˜æ—¥ï¼š<br><small id="maxLossDay">è®€å–ä¸­...</small></div>
        </div>
      </div>
      <div class="chart-container"><canvas id="profitTrendChart"></canvas></div>
    </section>

    <section class="container">
      <h2>ğŸ’¼ æˆ‘çš„æŠ•è³‡çµ„åˆ</h2>
      <div class="flex-row">
        <input type="text" id="pfSymbol" placeholder="è‚¡è™Ÿ" style="flex:1">
        <input type="number" id="pfShares" placeholder="è‚¡æ•¸" style="flex:1">
        <input type="number" id="pfCost" placeholder="æˆæœ¬" style="flex:1">
        <button onclick="addPortfolio()">æ–°å¢</button>
      </div>
      <div style="margin: 10px 0;">
        ğŸ“ˆ æç›Šï¼š<span id="todayTotalProfit">0</span> å…ƒ
        <button onclick="updateTodayProfit()" style="font-size: 12px; padding: 4px 8px;">ğŸ”„ åˆ·æ–°åŒæ­¥</button>
      </div>
      <ul id="portfolioList"></ul>
    </section>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCGSq-8joudLdCEB954krl3diNqMQXmsxg",
      authDomain: "piggynet-93c33.firebaseapp.com",
      databaseURL: "https://piggynet-93c33-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "piggynet-93c33",
      storageBucket: "piggynet-93c33.appspot.com",
      messagingSenderId: "65171780729",
      appId: "1:65171780729:web:ce5f7272f25a75f43490a8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let profitChartInstance = null;

    async function login() {
      const user = document.getElementById('loginUser').value;
      const pass = document.getElementById('loginPassword').value.trim();
      const snap = await db.ref(`users/${user}/password`).get();
      const stored = snap.exists() ? snap.val() : "9527";
      if (pass === stored) { localStorage.setItem('currentUser', user); location.reload(); }
      else alert("å¯†ç¢¼éŒ¯èª¤");
    }

    function logout() { localStorage.removeItem('currentUser'); location.reload(); }

    window.onload = () => {
      const user = localStorage.getItem('currentUser');
      if (user) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        initApp(user);
      }
    };

    function initApp(user) {
      loadPortfolio(user);
      loadAnnualReview(user);
      // updateTodayProfit æœƒåœ¨ loadPortfolio çš„ .on('value') ä¸­è‡ªå‹•è§¸ç™¼
    }

    async function updateTodayProfit() {
      const user = localStorage.getItem('currentUser');
      const snap = await db.ref(`users/${user}/portfolio`).get();
      if (!snap.exists()) {
          document.getElementById("currentNetWorth").textContent = "0";
          document.getElementById("todayTotalProfit").textContent = "0";
          document.getElementById('portfolioList').innerHTML = "";
          return;
      }

      const portfolio = snap.val();
      const codes = Object.keys(portfolio);

      document.getElementById("todayTotalProfit").textContent = "åŒæ­¥ä¸­...";
      document.getElementById("currentNetWorth").textContent = "è¨ˆç®—ä¸­...";

      try {
          // ç›´æ¥å¾å®˜æ–¹ OpenData æŠ“å–æ‰€æœ‰è‚¡ç¥¨ç•¶æ—¥æ”¶ç›¤
          const res = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY_ALL`);
          const allData = await res.json();
          
          const stockMap = new Map();
          allData.forEach(item => {
              stockMap.set(item.Code, parseFloat(item.ClosingPrice));
          });

          let totalP = 0; 
          let totalN = 0; 
          const listItems = [];

          codes.forEach(code => {
              const info = portfolio[code];
              const currentPrice = stockMap.get(code) || 0; 
              
              const profit = (currentPrice - info.cost) * info.shares;
              const value = currentPrice * info.shares;

              totalP += profit;
              totalN += value;

              const profitColor = profit >= 0 ? "red" : "green";
              listItems.push(`
                  <li>
                      <span><b>${code}</b> | ${info.shares}è‚¡ | æˆæœ¬:${info.cost} | ç¾åƒ¹:${currentPrice} 
                      <span style="color:${profitColor}; font-weight:bold;"> (æç›Š: ${Math.round(profit).toLocaleString()})</span></span>
                      <button onclick="removePortfolio('${code}')" style="margin-left:10px; padding:2px 5px; font-size:12px; background:#ff4444;">ğŸ—‘ï¸</button>
                  </li>
              `);
          });

          document.getElementById('portfolioList').innerHTML = listItems.join('');
          document.getElementById("todayTotalProfit").textContent = Math.round(totalP).toLocaleString();
          document.getElementById("currentNetWorth").textContent = Math.round(totalN).toLocaleString();

          const today = new Date().toISOString().split('T')[0];
          db.ref(`family/investSnapshot/${user}/${today}`).set({ profit: Math.round(totalP) });
          loadAnnualReview(user);

      } catch (e) {
          console.error("æ›´æ–°å¤±æ•—:", e);
          document.getElementById("todayTotalProfit").textContent = "APIé€£ç·šè¶…æ™‚";
      }
    }

    function loadPortfolio(user) {
      db.ref(`users/${user}/portfolio`).on('value', snap => {
          updateTodayProfit(); 
      });
    }

    function removePortfolio(code) {
      const user = localStorage.getItem('currentUser');
      if(confirm(`ç¢ºå®šåˆªé™¤ ${code} å—ï¼Ÿ`)) {
          db.ref(`users/${user}/portfolio/${code}`).remove();
      }
    }

    function addPortfolio() {
      const user = localStorage.getItem('currentUser');
      const code = document.getElementById('pfSymbol').value.trim();
      const shares = parseFloat(document.getElementById('pfShares').value);
      const cost = parseFloat(document.getElementById('pfCost').value);
      
      if(code && shares && cost) {
          db.ref(`users/${user}/portfolio/${code}`).set({ shares, cost }).then(() => {
              document.getElementById('pfSymbol').value = "";
              document.getElementById('pfShares').value = "";
              document.getElementById('pfCost').value = "";
          });
      } else {
          alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
      }
    }

    function loadAnnualReview(user) {
      db.ref(`family/investSnapshot/${user}`).once("value", snap => {
        const allEntries = Object.entries(snap.val() || {})
          .map(([d,v])=>({date:d, profit:v.profit}))
          .sort((a,b)=>new Date(a.date)-new Date(b.date));

        if (!allEntries.length) return;
        const chartEntries = allEntries.slice(-30);
        const max = chartEntries.reduce((p,c)=>c.profit > p.profit ? c : p);
        const min = chartEntries.reduce((p,c)=>c.profit < p.profit ? c : p);

        document.getElementById("maxGainDay").innerHTML = `${max.date}<br><span style="color:red;">$${max.profit.toLocaleString()}</span>`;
        document.getElementById("maxLossDay").innerHTML = `${min.date}<br><span style="color:green;">$${min.profit.toLocaleString()}</span>`;
        renderChart(chartEntries);
      });
    }

    function renderChart(entries) {
      const ctx = document.getElementById('profitTrendChart').getContext('2d');
      if (profitChartInstance) profitChartInstance.destroy();
      profitChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: entries.map(e => e.date.substring(5)),
          datasets: [{
            label: 'æç›Šè¶¨å‹¢',
            data: entries.map(e => e.profit),
            borderColor: '#f0a500',
            backgroundColor: 'rgba(240, 165, 0, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function setTheme(mode) {
      document.body.className = 'theme-' + mode;
      localStorage.setItem('themeMode', mode);
    }
  </script>
</body>
</html>
