
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f0a500">
  <meta charset="UTF-8" />
  <title>ğŸ·è±¬è±¬eç¶²ğŸ·</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 20px;
      max-width: 900px;
      background-color: #fdf6e3;
      color: #333;
      transition: background-color 0.4s, color 0.4s;
    }
    h1,h2,h3,h4 { margin-top: 0; }
    button {
      cursor: pointer; padding: 8px 14px; font-size: 16px;
      border-radius: 5px; border: none;
      background-color: #f0a500; color: #fff;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.15);
      transition: background-color 0.3s;
    }
    ul li button {
      background-color: #e74c3c;
      color: white;
      padding: 4px 8px;
      font-size: 14px;
      border-radius: 4px;
      margin-left: 10px;
    }
    ul li button:hover {
      background-color: #c0392b;
    }
    button:hover { background-color: #d88e00; }
    input, select, textarea {
      padding: 8px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 5px;
      width: 100%; box-sizing: border-box;
      transition: border-color 0.3s;
    }
    input:focus, select:focus, textarea:focus { border-color: #f0a500; outline: none; }
    textarea { resize: vertical; }
    ul {
      padding-left: 15px; list-style: none; margin: 8px 0;
      max-height: 160px; overflow-y: auto;
      border-radius: 6px; box-shadow: inset 0 0 5px #ccc; background: #fff;
    }
    ul li {
      padding: 8px 12px; border-bottom: 1px solid #eee;
      cursor: pointer; transition: background-color 0.2s;
    }
    ul li:hover { background-color: #ffe8a3; }
    .container {
      background: #fff3e0; border-radius: 10px; padding: 20px;
      margin-bottom: 25px; box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    }
    .header { text-align: center; margin-bottom: 20px; }
    .announcement {
      background-color: #fff8dc; border-left: 5px solid #f0a500;
      padding: 12px 15px; font-weight: bold; font-size: 1.1em;
      border-radius: 6px; box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    }
    .flex-row { display: flex; gap: 20px; flex-wrap: wrap; }
    .flex-grow { flex-grow: 1; min-width: 250px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    .small-note { font-size: 0.85em; color: #666; }
    .stat-box {
      background: #fff7cc; padding: 12px; border-radius: 8px;
      margin-top: 10px; box-shadow: inset 0 0 6px #f0a500aa;
      font-weight: 600;
    }
    body.theme-day { background-color: #fdf6e3; color: #333; }
    body.theme-day .container { background: #fff3e0; color: #333; }
    body.theme-day .announcement { background-color: #fff8dc; border-left-color: #f0a500; color: #444; }
    body.theme-night { background-color: #121212; color: #eee; }
    body.theme-night .container { background: #1e1e1e; color: #eee; }
    body.theme-night .announcement { background-color: #2a2a2a; border-left-color: #ffa500; color: #eee; }
    body.theme-night button { background-color: #ffa500; color: #222; box-shadow: 0 3px 6px rgb(255 165 0 / 0.6); }
    body.theme-night input, body.theme-night select, body.theme-night textarea { background: #333; border-color: #555; color: #eee; }
    body.theme-night ul { background: #1a1a1a; box-shadow: inset 0 0 5px #ffa500aa; color: #eee; }
    body.theme-night .small-note,
    body.theme-night ul,
    body.theme-night ul li,
    body.theme-night .stat-box,
    body.theme-night .announcement {
      color: #000 !important;
    }

    body.theme-forest { background-color: #1e2f1e; color: #000; }
    body.theme-forest .container { background: #2e4d2e; color: #000; }
    body.theme-forest .announcement { background-color: #3a6e3a; border-left-color: #aed581; color: #dcedc8; }
    body.theme-forest button { background-color: #aed581; color: #2e4d2e; }
    body.theme-forest input, body.theme-forest select, body.theme-forest textarea { background: #486b48; border-color: #aed581; color: #e8f5e9; }
    #chart { max-width: 100%; height: 300px; margin-top: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgb(0 0 255 / 0.15); background-color: white; }
    .top-right { position: fixed; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 999; }
    .small-note { font-size: 0.85em; color: #777; }
    #showList {
    max-height: none !important;
    overflow-y: visible !important;
    background: #fff;
    box-shadow: inset 0 0 5px #ccc;
    border-radius: 6px;
  }
  
    #portfolioList, #showList {
      max-height: none !important;
      overflow-y: visible !important;
      background: #fff;
      box-shadow: inset 0 0 5px #ccc;
      border-radius: 6px;
      padding: 6px;
      margin: 6px 0;
    }
    #portfolioList li, #showList li { border-bottom: 1px solid #eee; padding:6px 8px; }

  
/* --- Super Effects (lightweight CSS + JS) --- */
#weather-bg {
  position: fixed;
  inset: 0;
  z-index: -2;
  pointer-events: none;
  transition: opacity 0.8s ease, filter 0.8s ease;
}
/* base overlay so body themes still visible */
#weather-overlay {
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
  transition: opacity 0.8s ease;
}

/* Sunny */
.w-sunny {
  background: linear-gradient(180deg, #87ceeb 0%, #fdf6e3 60%);
  filter: brightness(1.03);
}

/* Cloudy */
.w-cloudy {
  background: linear-gradient(180deg, #dfe9f3 0%, #cfd8dc 60%);
}

/* Night */
.w-night {
  background: radial-gradient(circle at 20% 10%, #1b2b4a 0%, #071024 60%);
}

/* Rain layer (subtle animated raindrops using pseudo-elements) */
.rain-layer {
  position: absolute;
  inset: 0;
  background-image: linear-gradient(transparent 60%, rgba(255,255,255,0.03) 61%), linear-gradient(transparent 60%, rgba(255,255,255,0.02) 61%);
  background-size: 2px 60px, 3px 80px;
  opacity: 0.7;
  animation: rainMove 0.9s linear infinite;
}
@keyframes rainMove {
  from { transform: translateY(0) skewY(-10deg); }
  to { transform: translateY(60px) skewY(-10deg); }
}

/* Lightning flash */
.lightning-flash {
  position: absolute; inset: 0; background: rgba(255,255,255,0.0);
  animation: flash 4.5s linear infinite;
  pointer-events: none;
}
@keyframes flash {
  0%, 93%, 100% { opacity: 0; }
  94% { opacity: 0.85; }
  95% { opacity: 0; }
  97% { opacity: 0.6; }
}

/* --- FX animations --- */
/* clouds */
.fx-clouds { }
.fx-clouds .cloud {
  position: absolute;
  top: 10%;
  width: 220px; height: 70px;
  background: rgba(255,255,255,0.85);
  border-radius: 50px;
  filter: blur(6px);
  opacity: 0.9;
  animation: cloudFloat 20s linear infinite;
}
.fx-clouds .cloud.c2 { top: 30%; left: -200px; width: 360px; height: 90px; animation-duration: 30s; opacity: 0.7; filter: blur(8px); }
@keyframes cloudFloat { from { transform: translateX(-10%); } to { transform: translateX(120%); } }

/* stars twinkle */
.fx-stars { }
.fx-stars::before {
  content: "";
  position: absolute; inset: 0;
  background-image: radial-gradient(#ffffffaa 1px, transparent 2px);
  background-size: 6px 6px;
  opacity: 0.85;
  animation: twinkle 3s linear infinite;
  filter: blur(0.6px);
}
@keyframes twinkle { 0%{opacity:0.6}50%{opacity:1}100%{opacity:0.6} }

/* meteors: small streaks */
.fx-meteors { overflow: visible; }
.fx-meteors .meteor {
  position: absolute; width: 2px; height: 60px;
  background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0));
  transform: rotate(25deg);
  opacity: 0.0;
  animation: meteorAnim 2s linear infinite;
}
@keyframes meteorAnim {
  0% { opacity: 0; transform: translate(-10vw,-10vh) rotate(25deg) scale(0.2); }
  10% { opacity: 1; }
  100% { opacity: 0; transform: translate(110vw,70vh) rotate(25deg) scale(0.6); }
}

/* particles (gentle floating dots) */
.fx-particles { }
.fx-particles .p {
  position: absolute; width:8px;height:8px;border-radius:50%;
  background: radial-gradient(circle,#fff 0%, rgba(255,255,255,0.6) 60%);
  opacity: 0.9; filter: blur(1px);
  animation: floaty 8s linear infinite;
}
@keyframes floaty { 0%{transform:translateY(0)}50%{transform:translateY(-30px)}100%{transform:translateY(0)} }

/* fireworks (subtle bursts) */
.fx-fireworks .burst {
  position: absolute; width: 6px; height: 6px; border-radius: 50%;
  box-shadow: 0 0 10px 3px rgba(255,200,80,0.9);
  opacity: 0; animation: firework 1.2s linear infinite;
}
@keyframes firework {
  0% { transform: scale(0.2); opacity: 1; }
  70% { transform: scale(1.6); opacity: 0.9; }
  100% { transform: scale(2.4); opacity: 0; }
}

/* ensure content above effects stays readable */
.container, .header, .top-right, .announcement, #mainContent, #loginSection {
  position: relative;
  z-index: 10;
}

</style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="weather-bg"></div>

  <div id="loginSection" class="container" style="max-width:400px; margin:auto;">
  <h2>ğŸ‘¤ ä½¿ç”¨è€…ç™»å…¥</h2>
  <label>ä½¿ç”¨è€…åç¨±</label>
  <select id="loginUser">
    <option value="mom">åª½åª½</option>
    <option value="dad">çˆ¸çˆ¸</option>
    <option value="debby">å¦¹å¦¹</option>
    <option value="jason">Jason</option>
  </select>

  <label>å¯†ç¢¼</label>
  <input type="password" id="loginPassword" placeholder="è¼¸å…¥å¯†ç¢¼" />
  <button onclick="login()">ç™»å…¥</button>
</div>
<div id="mainContent" style="display:none;">
  <div class="top-right">
    <button onclick="setTheme('day')">ğŸŒ ç™½å¤©</button>
    <button id="weatherBtn" onclick="randomWeather()">â›… å¤©æ°£</button>
    <button id="fxBtn" onclick="randomFX()">âœ¨ å‹•ç•«</button>
    <button onclick="changePassword()">ğŸ” ä¿®æ”¹å¯†ç¢¼</button>
    <button onclick="logout()">ğŸšª ç™»å‡º</button>
  </div>

  <div class="header" style="display:flex;justify-content:space-between;align-items:center;">
    <h1 style="margin:0">ğŸ· è±¬è±¬eç¶²</h1>
    <div class="announcement">ğŸ“¢ è¨˜å¸³å€ä¸Šç·šå•¦ï¼è«‹åª½åª½å’Œå¦¹å¦¹çµ¦æˆ‘ä¸€ç™¾è¬</div>
  </div>

  <div style="margin-bottom: 20px;">
    <section class="container">
      <h2>ğŸ’¬ å®¶åº­å…¬å‘Šæ¿</h2>
      <div id="boardMessages" style="background:#fff; padding:10px; border-radius:8px; max-height:200px; overflow-y:auto; box-shadow:inset 0 0 5px #ccc;"></div>
      <div style="margin-top:10px;">
        <textarea id="boardInput" placeholder="è¼¸å…¥ç•™è¨€..." rows="2"></textarea>
        <button onclick="postMessage()">ç™¼ä½ˆç•™è¨€</button>
      </div>
    </section>

    <h3>ğŸ§© æ–°é›»å½±å€ https://www.movieffm.net/home/</h3>

    <section class="container">
      <h2>ğŸ¬ é—œæ³¨çš„ç¯€ç›®</h2>
      <div style="margin-bottom:10px;">
        <input type="url" id="showUrlInput" placeholder="è¼¸å…¥ç¯€ç›®ç¶²å€ï¼Œä¾‹å¦‚ï¼šhttps://www.movieffm.net/drama/372471/" />
        <button id="addShowBtn">â• æ–°å¢ç¯€ç›®</button>
        <button onclick="loadShows(true)">ğŸ”„ æ›´æ–°ç¯€ç›®</button>
        <small class="small-note">æ–°å¢æ™‚æœƒæ“·å–è©²é çš„æ¨™é¡Œã€ç‹€æ…‹èˆ‡æ›´æ–°æ™‚é–“</small>
      </div>
      <ul id="showList"><li>å°šæœªè¿½è¹¤ä»»ä½•ç¯€ç›®</li></ul>
    </section>

    <div style="overflow:hidden; border: 2px solid #f0a500; border-radius: 10px; height: 600px;">
      <iframe src="https://www.movieffm.net/movies/?genres&region&dtyear&cats&orderby=date&tvtype"
        width="100%" height="600" style="transform:scale(1); transform-origin: 0 0; border:none;">
      </iframe>
    </div>

    <h3>ğŸ§© å…è²»è²¼åœ–å€(æ›´å¤š)</h3>
    <div style="overflow:hidden; border: 2px solid #f0a500; border-radius: 10px; height: 600px;">
      <iframe src="https://giftshop-campaign.landpress.line.me/sticker/?utm_source=lineshopping&utm_medium=sticker_page&utm_campaign=2025.11"
        width="100%" height="600" style="transform:scale(1); transform-origin: 0 0; border:none;">
      </iframe>
    </div>

  

    

    <section class="container">
      <h2>ğŸµ å®¶åº­éŸ³æ¨‚ç‰†</h2>
      <p class="small-note">æ¯äººå¯æ–°å¢å¸¸è½çš„ Spotify/Youtube æ›²ç›®ï¼Œä¹Ÿå¯ç•™è¨€å‘¦~~~</p>
      <div style="display:flex; gap:8px; margin-bottom:8px;">
  <input id="musicInputTitle" placeholder="æ›²åæˆ–æè¿°" style="flex:1;">
  <input id="musicInputEmbed" placeholder="Spotify/Youtube é€£çµ" style="flex:1;">
  <select id="musicOwner" style="flex:1;">
    <option value="mom">åª½åª½</option>
    <option value="dad">çˆ¸çˆ¸</option>
    <option value="debby">å¦¹å¦¹</option>
    <option value="jason">Jason</option>
  </select>
  <button onclick="addMusicTrack()">â• æ–°å¢</button>
</div>

      <div id="musicWallGrid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px;"></div>
    </section>

<section class="container">
    <h2>ğŸ“Š æ¯æ—¥è¨˜å¸³</h2>

    <div class="flex-row">
      <div class="flex-grow">
        <label>é¸æ“‡è¨˜å¸³äºº</label>
        <input type="text" id="roleSelect" readonly style="background:#eee; font-weight:bold;">
        <small class="small-note">ç›®å‰ç™»å…¥çš„ä½¿ç”¨è€…</small>

        <small class="small-note">å…¨å®¶å…±ç”¨è³‡æ–™åº«ï¼Œè§’è‰²åªåšåˆ†é¡ç”¨é€”ã€‚</small>
      </div>
      <div class="flex-grow">
        <label>é¸æ“‡é¡åˆ¥</label>
        <select id="categorySelect">
          <option value="é£Ÿç‰©">ğŸ” é£Ÿç‰©</option>
          <option value="äº¤é€š">ğŸšŒ äº¤é€š</option>
          <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
          <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
        </select>
      </div>
    </div>
    <label>é‡‘é¡</label>
    <input type="number" id="amountInput" min="0" step="0.01" placeholder="è¼¸å…¥é‡‘é¡" />

    <label>æè¿°</label>
    <textarea id="descriptionInput" rows="2" placeholder="è¼¸å…¥æè¿°"></textarea>

    <button onclick="addRecord()">è¨˜éŒ„æ”¯å‡º</button>
    <hr>

    <hr>

    <h3 style="display:flex;justify-content:space-between;align-items:center;">
      ğŸ“œ æœ€è¿‘è¨˜å¸³ç´€éŒ„
      <span style="font-size:0.9em;">
        <select id="filterYear" style="padding:4px;"></select>
        <select id="filterMonth" style="padding:4px;"></select>
        <button onclick="filterRecords()" style="padding:4px 8px;margin-left:6px;">ç¯©é¸</button>
        <button onclick="resetRecordFilter()" style="padding:4px 8px;margin-left:6px;">å…¨éƒ¨</button>
      </span>
    </h3>
    <ul id="recordList"><li>æš«ç„¡è¨˜éŒ„</li></ul>

    <hr>

    <h3>ğŸ“ˆ æ”¯å‡ºçµ±è¨ˆ</h3>
    <div id="statsBox" class="stat-box">
      <p>ä»Šæ—¥ç¸½æ”¯å‡ºï¼š<span id="todayTotal">0</span> å…ƒ</p>
      <p>æœ€è¿‘ 7 å¤©å¹³å‡æ¯æ—¥æ”¯å‡ºï¼š<span id="avg7Days">0</span> å…ƒ</p>
      <p>æœ€è¿‘ 30 å¤©å¹³å‡æ¯æ—¥æ”¯å‡ºï¼š<span id="avg30Days">0</span> å…ƒ</p>
      <p>ç•¶æœˆç´¯è¨ˆæ”¯å‡ºï¼š<span id="monthTotal">0</span> å…ƒ</p>
      <p id="warningMsg" style="color:#c0392b; font-weight:bold;"></p>
    </div>
    <section class="container">
  <h2>ğŸ’° æ™ºæ…§ç†è²¡é¡§å•</h2>

  <div style="margin-bottom: 10px;">
    <label>æœˆè–ªï¼ˆå…ƒï¼‰</label>
    <input type="number" id="salaryInput" placeholder="ä¾‹å¦‚ 50000" />
    <button onclick="saveSalary()">ğŸ’¾ å„²å­˜æœˆè–ª</button>
    <span id="salaryStatus" style="margin-left:8px;color:green;"></span>
  </div>

  <details style="margin-bottom: 15px;">
    <summary>âš™ï¸ è‡ªè¨‚å„é¡æ”¯å‡ºå»ºè­°æ¯”ä¾‹ï¼ˆ%ï¼‰</summary>
    <div style="margin-top: 8px;">
      <label>é£Ÿç‰©ï¼š</label><input type="number" id="limit_food" value="35" style="width:60px;">%
      <label style="margin-left:10px;">äº¤é€šï¼š</label><input type="number" id="limit_transport" value="15" style="width:60px;">%
      <label style="margin-left:10px;">å¨›æ¨‚ï¼š</label><input type="number" id="limit_entertainment" value="15" style="width:60px;">%
      <label style="margin-left:10px;">å…¶ä»–ï¼š</label><input type="number" id="limit_other" value="20" style="width:60px;">%
      <button onclick="saveLimits()" style="margin-left:10px;">ğŸ’¾ å„²å­˜</button>
    </div>
  </details>

  <button onclick="analyzeFinance()">ğŸ“Š åˆ†ææœ¬æœˆç†è²¡å»ºè­°</button>
  <div id="financeAdvice" class="stat-box" style="margin-top:10px;">è«‹è¼¸å…¥æœˆè–ªä¸¦é»æ“Šåˆ†æ</div>

  <canvas id="financeChart" style="margin-top:20px;max-width:400px;"></canvas>
</section>

    <h3>ğŸ“Š å„é¡åˆ¥æ”¯å‡ºçµ±è¨ˆ</h3>
    <label>é–‹å§‹æ—¥æœŸ</label>
    <input type="date" id="startDate" />

    <label>çµæŸæ—¥æœŸ</label>
    <input type="date" id="endDate" />
    <button onclick="analyzeCategory()">æŸ¥çœ‹çµ±è¨ˆ</button>
    <div id="categoryResult" class="stat-box">é»æ“ŠæŸ¥çœ‹çµ±è¨ˆè³‡æ–™</div>
    <canvas id="categoryChart" style="margin-top: 15px;"></canvas>
  </section>
  <!-- ===== ğŸ“‰ è³‡ç”¢å¿«ç…§ï¼ˆæ•´åˆæœ€çµ‚ç‰ˆï¼‰===== -->
<section class="container" id="assetSnapshotRoot">
  <h2>ğŸ“‰ 2026 è³‡ç”¢å¿«ç…§</h2>

  <div class="stat-box">
    <p>
      ğŸ’° ç•¶å‰è³‡ç”¢ç¸½ç¾å€¼ï¼š
      <span id="currentNetWorth"
        style="font-size:1.5em;color:#f0a500;font-weight:bold;">0</span> å…ƒ
    </p>

    <div class="flex-row" style="margin-top:10px;">
      <div class="flex-grow">
        ğŸš€ ä»Šå¹´è³ºæœ€å¤šï¼š<br>
        <small id="maxGainDay">è®€å–ä¸­...</small>
      </div>
      <div class="flex-grow">
        ğŸ“‰ ä»Šå¹´æœ€æ…˜æ—¥ï¼š<br>
        <small id="maxLossDay">è®€å–ä¸­...</small>
      </div>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="profitTrendChart"></canvas>
  </div>
</section>

  <section class="container">
      <h2>ğŸ’¼ æˆ‘çš„æŠ•è³‡çµ„åˆ</h2>
      <div class="flex-row">
        <div class="flex-grow">
          <input type="text" id="pfSymbol" placeholder="ä¾‹å¦‚ 2330" />
        </div>
        <div class="flex-grow">
          <label>æŒè‚¡æ•¸é‡</label>
          <input type="number" id="pfShares" placeholder="100" />
        </div>
        <div class="flex-grow">
          <label>æˆæœ¬åƒ¹</label>
          <input type="number" id="pfCost" placeholder="560" />
        </div>
        <button onclick="addPortfolio()">æ–°å¢</button>
      </div>

      <h3 style="margin-top:15px;">ğŸ“‹ æˆ‘çš„æŒè‚¡åˆ—è¡¨ è³‡ç”¢å¿«ç…§: https://az964115.github.io/family-stock/ </h3>
      <div id="totalProfitSection">
        ğŸ“ˆ æœ€æ–°æ”¶ç›¤åƒ¹(ä¸Šä¸€å€‹1330)ç¸½æç›Šï¼š<span id="todayTotalProfit">0</span> å…ƒ
      </div>
      <ul id="portfolioList"><li>æš«ç„¡è³‡æ–™</li></ul>
    </section>

</div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCGSq-8joudLdCEB954krl3diNqMQXmsxg",
      authDomain: "piggynet-93c33.firebaseapp.com",
      databaseURL: "https://piggynet-93c33-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "piggynet-93c33",
      storageBucket: "piggynet-93c33.appspot.com",
      messagingSenderId: "65171780729",
      appId: "1:65171780729:web:ce5f7272f25a75f43490a8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userRef = null;
    let expenseRef = null;
    let stockRef = null;
    let pfRef = null;
    let showRef = null;
    const favRef = db.ref('favorites/stockList');

    const roleSelect = document.getElementById('roleSelect');
    const categorySelect = document.getElementById('categorySelect');
    const amountInput = document.getElementById('amountInput');
    const descriptionInput = document.getElementById('descriptionInput');
    const recordList = document.getElementById('recordList');
    const todayTotalEl = document.getElementById('todayTotal');
    const avg7Days = document.getElementById('avg7Days');
    const avg30Days = document.getElementById('avg30Days');
    const monthTotalEl = document.getElementById('monthTotal');
    const warningMsg = document.getElementById('warningMsg');
    const salaryInput = document.getElementById('salaryInput');
    const salaryStatus = document.getElementById('salaryStatus');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const symbolInput = document.getElementById('symbolInput');
    const favoriteList = document.getElementById('favoriteList');
    const newFavorite = document.getElementById('newFavorite');
    const chartCanvas = document.getElementById('chart');

    const USERS = {
      mom: "me",
      dad: "dt",
      debby: "dua",
      jason: "952"
    };

    function initForUser(user){
      document.getElementById('roleSelect').value = user;

      userRef = db.ref(`users/${user}/records`);
      expenseRef = db.ref(`users/${user}/expenses`);
      stockRef = db.ref(`users/${user}/stocks`);
      pfRef = db.ref(`users/${user}/portfolio`);
      showRef = db.ref(`users/${user}/shows`);
db.ref(`users/${user}/profile/salary`).once('value').then(snap => {
  if (snap.exists()) {
    const salary = snap.val();
    document.getElementById('salaryInput').value = salary;
    document.getElementById('salaryStatus').textContent = `å·²è¼‰å…¥ è³‡æ–™åº« æœˆè–ªï¼š${salary} å…ƒ`;
  } else {
    document.getElementById('salaryStatus').textContent = 'å°šæœªè¨­å®šæœˆè–ª';
  }
});
const now = new Date();
const year = now.getFullYear();
const month = String(now.getMonth() + 1).padStart(2, '0');
const firstDay = `${year}-${month}-01`; 
const today = now.toISOString().split('T')[0]; 

document.getElementById('startDate').value = firstDay;
document.getElementById('endDate').value = today;

      

      loadRecentRecords();
      updateStats();
      loadPortfolio();
      loadFavorites();
      updateTodayProfit();

      loadShows(true);
      try {
        const userShowsRef = db.ref(`users/${user}/shows`);
        userShowsRef.on('child_changed', snap => {
          const data = snap.val() || {};
          if (data && data.lastChecked) {
            notifyUpdate(data.title || data.url, data);
          }
        });
      } catch(e){ console.warn('show change listener error', e); }
    }

    const boardRef = db.ref("family/board");
    function loadBoard() {
      boardRef.limitToLast(10).on("value", snap => {
        const box = document.getElementById("boardMessages");
        const data = snap.val();
        const currentUser = localStorage.getItem("currentUser");
        box.innerHTML = "";
        if (!data) {
          box.innerHTML = "<p>ç›®å‰æ²’æœ‰ç•™è¨€ã€‚</p>";
          return;
        }
        const entries = Object.entries(data)
          .map(([key, val]) => ({ key, ...val }))
          .sort((a,b)=>b.time-a.time);

        entries.forEach(m => {
          const t = new Date(m.time).toLocaleString('zh-TW');
          const div = document.createElement('div');
          div.style.borderBottom = "1px solid #eee";
          div.style.padding = "6px 0";
          div.innerHTML = `
            <b>${m.user}</b>ï¼š${m.msg}
            <span style="color:#777;font-size:0.85em;">(${t})</span>
            ${m.user === currentUser ? `<button style="margin-left:10px;font-size:12px;" onclick="deleteBoardMessage('${m.key}')">ğŸ—‘ï¸ åˆªé™¤</button>` : ""}
          `;
          box.appendChild(div);
        });
      });
    }
    function delayInactivity(user) {
  const dayMs = 86400000;
  const newDelay = Date.now() + 2 * dayMs;
  firebase.database().ref(`users/${user}/inactivityDelayUntil`).set(newDelay)
    .then(() => {
      alert("å·²å»¶å¾Œå…©å¤©æé†’ï¼");
      checkInactivity(); // æ›´æ–°ç•«é¢
    });
}
    function deleteBoardMessage(key) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç•™è¨€ï¼Ÿ")) return;
      boardRef.child(key).remove()
        .then(()=>alert("ç•™è¨€å·²åˆªé™¤"))
        .catch(e=>console.error(e));
    }
    function postMessage(){
      const msg = document.getElementById("boardInput").value.trim();
      if (!msg) return alert("è«‹è¼¸å…¥å…§å®¹");
      boardRef.push({
        user: localStorage.getItem("currentUser"),
        msg,
        time: Date.now()
      });
      document.getElementById("boardInput").value = "";
    }

    window.addEventListener("load", loadBoard);
    window.addEventListener("load", () => {
  loadBoard();
  
  // --- æ–°å¢é€™æ®µï¼šæª¢æŸ¥ç€è¦½å™¨æ˜¯å¦å­˜æœ‰ç™»å…¥è³‡è¨Š ---
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    // å¦‚æœæœ‰å­˜éä½¿ç”¨è€…ï¼Œç›´æ¥é¡¯ç¤ºä¸»ç•«é¢ä¸¦åˆå§‹åŒ–
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    initForUser(savedUser);
  }
  // ------------------------------------------
});

    function loadPortfolio() {
      if (!pfRef) return;
      pfRef.on("value", async snap => {
        const data = snap.val() || {};
        const list = document.getElementById("portfolioList");
        list.innerHTML = "";

        for (const [code, info] of Object.entries(data)) {
          try {
            const res = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&stockNo=${code}`);
            const stock = await res.json();
            let price = 0;
            if (stock.stat === "OK" && stock.data.length > 0) {
              const last = stock.data[stock.data.length - 1];
              price = parseFloat(last[6].replace(/,/g, ""));
            }
            const gain = ((price - info.cost) * info.shares).toFixed(2);
            const color = gain >= 0 ? "red" : "green";
            const li = document.createElement("li");
            li.innerHTML = `
              <b>${code}</b>ï½œ${info.shares}è‚¡ï½œæˆæœ¬ ${info.cost}ï½œç¾åƒ¹ ${price.toFixed(2)}ï½œ
              <span style="color:${color}; font-weight:bold;">æç›Š ${gain}</span>
              <button onclick="removePortfolio('${code}')" style="margin-left:8px;">åˆªé™¤</button>
            `;
            list.appendChild(li);
          } catch (e) {
            console.error(e);
          }
        }
        if (list.innerHTML === "") list.innerHTML = "<li>æš«ç„¡è³‡æ–™</li>";
      });
    }
async function updateTodayProfit() {
  if (!pfRef) return;
  const snapshot = await pfRef.get();
  const data = snapshot.val() || {};
  let totalProfit = 0;

  for (const [code, { shares, cost }] of Object.entries(data)) {
    try {
      const res = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&stockNo=${code}`);
      const stockData = await res.json();
      if (stockData.stat === "OK" && stockData.data.length > 0) {
        const lastPrice = parseFloat(stockData.data[stockData.data.length - 1][6].replace(/,/g, ""));
        totalProfit += (lastPrice - cost) * shares;
      }
    } catch (e) { console.error(e); }
  }

  const formattedProfit = totalProfit.toFixed(2);
  document.getElementById("todayTotalProfit").textContent = formattedProfit;
  // ã€é€£å‹•ä¿®æ”¹ã€‘åŒæ­¥æ›´æ–° 2026 è³‡ç”¢å¿«ç…§çš„æ•¸å­—
  document.getElementById("currentNetWorth").textContent = parseFloat(formattedProfit).toLocaleString();
  
  const el = document.getElementById("todayTotalProfit");
  el.className = totalProfit >= 0 ? "profit-positive" : "profit-negative";
}

    function addPortfolio() {
      const code = document.getElementById('pfSymbol').value.trim();
      const shares = parseFloat(document.getElementById('pfShares').value);
      const cost = parseFloat(document.getElementById('pfCost').value);
      if (!code || isNaN(shares) || isNaN(cost)) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
      pfRef.child(code).set({ shares, cost });
      document.getElementById('pfSymbol').value = document.getElementById('pfShares').value = document.getElementById('pfCost').value = "";
    }

    function removePortfolio(code) {
      if (confirm("ç¢ºå®šåˆªé™¤é€™ç­†æŠ•è³‡ï¼Ÿ")) pfRef.child(code).remove();
    }

    async function logout() {
      localStorage.removeItem('currentUser');
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      recordList.innerHTML = '<li>æš«ç„¡è¨˜éŒ„</li>';
      todayTotalEl.textContent = '0';
      avg7Days.textContent = '0';
      avg30Days.textContent = '0';
      monthTotalEl.textContent = '0';
      warningMsg.textContent = '';
      alert('æ‚¨å·²ç™»å‡ºï¼');
    }

    async function changePassword() {
      const user = localStorage.getItem('currentUser');
      if (!user) return alert("è«‹å…ˆç™»å…¥");

      const oldPass = prompt("è«‹è¼¸å…¥èˆŠå¯†ç¢¼ï¼š");
      if (!oldPass) return;

      const snap = await db.ref(`users/${user}/password`).get();
      const currentPass = snap.exists() ? snap.val() : USERS[user];

      if (oldPass !== currentPass) {
        alert("èˆŠå¯†ç¢¼éŒ¯èª¤ï¼");
        return;
      }

      const newPass = prompt("è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘3å€‹å­—ï¼‰");
      if (!newPass || newPass.length < 3) {
        alert("æ–°å¯†ç¢¼ç„¡æ•ˆï¼");
        return;
      }

      await db.ref(`users/${user}/password`).set(newPass);
      USERS[user] = newPass;
      localStorage.setItem('lastChangedPass', newPass);

      alert("âœ… å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼Œä¸‹æ¬¡ç™»å…¥è«‹ä½¿ç”¨æ–°å¯†ç¢¼ï¼");
    }

    async function login(){
      const user = document.getElementById('loginUser').value;
      const pass = document.getElementById('loginPassword').value.trim();

      const ref = db.ref(`users/${user}/password`);
      const snap = await ref.get();
      let storedPass;

      if (snap.exists()) {
        storedPass = snap.val();
      } else {
        storedPass = USERS[user];
        await ref.set(storedPass);
      }
      if(pass === storedPass){
        localStorage.setItem('currentUser', user);
        alert(`æ­¡è¿å›ä¾†ï¼Œ${user}!`);
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        initForUser(user);
      } else {
        alert("å¯†ç¢¼éŒ¯èª¤ï¼");
        document.getElementById('loginPassword').value = "";
      }
    }

    window.login = login;

    function setTheme(mode){
      document.body.classList.remove('theme-day','theme-night','theme-forest');
      document.body.classList.add(`theme-${mode}`);
      localStorage.setItem('themeMode', mode);
    }
    setTheme(localStorage.getItem('themeMode') || 'day');


    function addRecord(){
      const role = roleSelect.value;
      const category = categorySelect.value;
      const amount = parseFloat(amountInput.value);
      const desc = descriptionInput.value.trim();
      if(isNaN(amount)||amount<=0){ alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'); return; }
      const now = new Date();
      const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 10);
      const record={role,category,amount,description:desc,timestamp:now.getTime(),date:localDate};
      userRef.push(record,err=>{
        if(err){alert('å„²å­˜å¤±æ•—');console.error(err);}
        else{alert('è¨˜å¸³æˆåŠŸ');amountInput.value='';descriptionInput.value='';loadRecentRecords();updateStats();}
      });
    }

    function loadRecentRecords(){
      if (!userRef) return;
      userRef.orderByChild('timestamp').limitToLast(20).once('value', snap => {
        const records = snap.val(), list = recordList;
        list.innerHTML = '';
        if (!records) {
          list.innerHTML = '<li>æš«ç„¡è¨˜éŒ„</li>';
          return;
        }
        Object.entries(records)
          .sort((a, b) => b[1].timestamp - a[1].timestamp)
          .forEach(([key, r]) => {
            const li = document.createElement('li');
            li.innerHTML = `
              <div style="display:flex; justify-content: space-between; align-items: center;">
                <span>${r.date} - ${r.role} - ${r.category} - ${r.amount} å…ƒ - ${r.description}</span>
                <button onclick="deleteRecord('${key}')">ğŸ—‘ï¸ åˆªé™¤</button>
              </div>
            `;
            list.appendChild(li);
          });
      });
    }

    function deleteRecord(key) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;

      userRef.child(key).remove(err => {
        if (err) {
          alert("åˆªé™¤å¤±æ•—ï¼");
          console.error(err);
        } else {
          alert("å·²åˆªé™¤ç´€éŒ„ï¼");
          loadRecentRecords();
          updateStats();
        }
      });
    }

    async function updateStats(){
      if (!userRef) {
        todayTotalEl.textContent = '0';
        avg7Days.textContent = '0';
        avg30Days.textContent = '0';
        monthTotalEl.textContent = '0';
        warningMsg.textContent = '';
        return;
      }
      const snap=await userRef.once('value');
      const arrRaw = snap.val() || {};
      const arr = Object.values(arrRaw);
      const now=Date.now(),day=86400000;

      const today = new Date(Date.now() - new Date().getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 10);

      if (arr.length === 0) {
        todayTotalEl.textContent = '0.00';
        avg7Days.textContent = '0.00';
        avg30Days.textContent = '0.00';
        monthTotalEl.textContent = '0.00';
        warningMsg.textContent = '';
        return;
      }

      const todayTotal = arr.filter(r=>r.date===today).reduce((s,r)=>s+ (parseFloat(r.amount)||0),0);
      const arr7=arr.filter(r=>now - r.timestamp < 7*day);
      const arr30 = arr.filter(r => now - r.timestamp < 30*day);

      const sum7 = arr7.reduce((s,r)=>s + (parseFloat(r.amount)||0),0);
      const sum30 = arr30.reduce((s,r)=>s + (parseFloat(r.amount)||0),0);

      const avg7 = +(sum7 / 7);
      const avg30 = +(sum30 / 30);
      const month = today.slice(0,7);
      const monthTotal = arr.filter(r=>r.date.startsWith(month)).reduce((s,r)=>s + (parseFloat(r.amount)||0),0);

      warningMsg.textContent = todayTotal > 1000 ? "âš ï¸ ä»Šæ—¥èŠ±å¤ªå¤šå•¦ï¼" : "";
      todayTotalEl.textContent = todayTotal.toFixed(2);
      avg7Days.textContent = avg7.toFixed(2);
      avg30Days.textContent = avg30.toFixed(2);
      monthTotalEl.textContent = monthTotal.toFixed(2);
    }

    function analyzeCategory() {
      const start = startDateInput.value;
      const end = endDateInput.value;

      if (!start || !end) {
        alert('è«‹é¸æ“‡å®Œæ•´çš„èµ·è¨–æ—¥æœŸ');
        return;
      }
      if (start > end) {
        alert('èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
        return;
      }
      userRef.once('value').then(snap => {
        const records = Object.values(snap.val() || []);
        if (records.length === 0) {
          categoryResult.textContent = 'æš«ç„¡è³‡æ–™';
          return;
        }
        const filtered = records.filter(r => r.date >= start && r.date <= end);
        if (filtered.length === 0) {
          categoryResult.textContent = 'æ­¤å€é–“ç„¡è³‡æ–™';
          if (window.categoryChart) window.categoryChart.destroy();
          return;
        }
        const categoryMap = {};
        filtered.forEach(r => {
          categoryMap[r.category] = (categoryMap[r.category] || 0) + (parseFloat(r.amount)||0);
        });

        const categories = Object.keys(categoryMap);
        const values = categories.map(c => categoryMap[c]);

        categoryResult.innerHTML = categories.map(c =>
          `${c}: ${categoryMap[c].toFixed(2)} å…ƒ`
        ).join('<br>');

        if (window.categoryChart) window.categoryChart.destroy();
        const ctx = document.getElementById('categoryChart').getContext('2d');
        window.categoryChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: categories,
            datasets: [{
              label: 'å„é¡åˆ¥æ”¯å‡ºç¸½é¡',
              data: values,
              backgroundColor: ['#f39c12', '#3498db', '#2ecc71', '#9b59b6'],
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: getComputedStyle(document.body).color }
              },
              x: {
                ticks: { color: getComputedStyle(document.body).color }
              }
            },
            plugins: {
              legend: {
                labels: { color: getComputedStyle(document.body).color }
              }
            }
          }
        });
      });
    }

    function saveSalary() {
      const salary = parseFloat(salaryInput.value);
      if (isNaN(salary) || salary <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æœˆè–ªé‡‘é¡');
        return;
      }
      const currentUser = localStorage.getItem("currentUser");
      if (!currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }
      localStorage.setItem(`${currentUser}_salary`, salary);
      db.ref(`users/${currentUser}/profile/salary`).set(salary).catch(e=>console.error(e));
      salaryStatus.textContent = `å·²å„²å­˜ï¼š${salary} å…ƒ`;
    }

    function saveLimits() {
      const limits = {
        food: parseFloat(document.getElementById('limit_food').value),
        transport: parseFloat(document.getElementById('limit_transport').value),
        entertainment: parseFloat(document.getElementById('limit_entertainment').value),
        other: parseFloat(document.getElementById('limit_other').value)
      };
      const currentUser = localStorage.getItem('currentUser');
      if (!currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }
      localStorage.setItem(`${currentUser}_limits`, JSON.stringify(limits));
      alert('å·²å„²å­˜è‡ªè¨‚æ”¯å‡ºæ¯”ä¾‹è¨­å®šï¼');
    }

    let financeChart;

    function analyzeFinance() {
      const salary = parseFloat(salaryInput.value);
      if (isNaN(salary) || salary <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æœˆè–ªé‡‘é¡');
        return;
      }
      const currentUser = localStorage.getItem('currentUser');
      const limits = JSON.parse(localStorage.getItem(`${currentUser}_limits`) || '{}');
      const limitDefaults = { food: 35, transport: 15, entertainment: 15, other: 20 };
      const mergedLimits = { ...limitDefaults, ...limits };

      userRef.once('value').then(snap => {
        const records = Object.values(snap.val() || []);
        if (records.length === 0) {
          document.getElementById('financeAdvice').textContent = 'æš«ç„¡æ”¯å‡ºè³‡æ–™';
          return;
        }

        const now = new Date();
        const thisMonth = now.toISOString().slice(0, 7);
        const monthRecords = records.filter(r => r.date.startsWith(thisMonth));

        if (monthRecords.length === 0) {
          document.getElementById('financeAdvice').textContent = `æœ¬æœˆï¼ˆ${thisMonth}ï¼‰å°šç„¡è¨˜å¸³è³‡æ–™`;
          return;
        }

        const total = monthRecords.reduce((sum, r) => sum + (parseFloat(r.amount)||0), 0);
        const categoryMap = {};
        monthRecords.forEach(r => {
          categoryMap[r.category] = (categoryMap[r.category] || 0) + (parseFloat(r.amount)||0);
        });

        let adviceText = `<p>ğŸ“… æœ¬æœˆ(${thisMonth})ç¸½æ”¯å‡ºï¼š${total.toFixed(2)} å…ƒï¼ˆ${(total/salary*100).toFixed(1)}% æœˆè–ªï¼‰</p><ul>`;
        for (const [cat, amt] of Object.entries(categoryMap)) {
          const pct = amt / salary * 100;
          let limit = mergedLimits.other;
          if (cat === 'é£Ÿç‰©') limit = mergedLimits.food;
          else if (cat === 'äº¤é€š') limit = mergedLimits.transport;
          else if (cat === 'å¨›æ¨‚') limit = mergedLimits.entertainment;

          let msg = "";
          if (pct > limit) msg = `âš ï¸ è¶…å‡ºå»ºè­° ${limit}% ä¸Šé™ï¼Œå»ºè­°æª¢è¦–æ”¯å‡ºã€‚`;
          else if (pct > limit * 0.8) msg = `âš ï¸ æ¥è¿‘ä¸Šé™ (${limit}%)ï¼Œè«‹ç•™æ„æ§åˆ¶ã€‚`;
          else msg = `âœ… åœ¨åˆç†ç¯„åœå…§ã€‚`;

          adviceText += `<li>${cat}ï¼š${amt.toFixed(2)} å…ƒï¼ˆ${pct.toFixed(1)}%ï¼‰â†’ ${msg}</li>`;
        }
        adviceText += "</ul>";

        if (total > salary * 0.9)
          adviceText += `<p style="color:red;font-weight:bold;">ğŸš¨ æœ¬æœˆæ”¯å‡ºå·²é”æœˆè–ª 90%ï¼Œè«‹ç«‹å³æª¢è¦–é–‹éŠ·ï¼</p>`;
        else if (total < salary * 0.6)
          adviceText += `<p style="color:green;">ğŸŒ± å„²è“„æ¯”ä¾‹è¶…é 40%ï¼ŒæŒçºŒä¿æŒï¼</p>`;

        document.getElementById('financeAdvice').innerHTML = adviceText;

        const ctx = document.getElementById('financeChart').getContext('2d');
        if (financeChart) financeChart.destroy();
        financeChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(categoryMap),
            datasets: [{
              data: Object.values(categoryMap),
              backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0']
            }]
          },
          options: {
            plugins: {
              title: { display: true, text: `å„é¡æ”¯å‡ºä½”æ¯”ï¼ˆå…± ${total.toFixed(0)} å…ƒï¼‰` },
              legend: { position: 'bottom' }
            }
          }
        });
      });
    }

    async function loadFavorites() {
      favRef.once('value', async snap => {
        const favs = snap.val() || {};
        const list = favoriteList;
        list.innerHTML = '';
        const codes = Object.keys(favs || {});
        const seen = new Set();
        if (codes.length === 0) {
          favRef.update({ '2330': true, '0050': true });
          return loadFavorites();
        }

        for (const code of codes) {
          if (seen.has(code)) continue;
          seen.add(code);

          try {
            const res = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&stockNo=${code}`);
            const data = await res.json();
            if (data.stat === "OK" && data.data.length > 1) {
              const last = parseFloat(data.data[data.data.length - 1][6].replace(/,/g, ""));
              const prev = parseFloat(data.data[data.data.length - 2][6].replace(/,/g, ""));
              const diff = (last - prev).toFixed(2);
              const color = diff >= 0 ? "red" : "green";
              const li = document.createElement('li');
              li.innerHTML = `${code} <span style="color:${color};">(${diff >= 0 ? 'â–²' : 'â–¼'}${Math.abs(diff)})</span>`;
              li.addEventListener('click', () => { symbolInput.value = code; loadStock(); });
              list.appendChild(li);
            } else {
              const li = document.createElement('li');
              li.textContent = code + 'ï¼ˆç„¡è³‡æ–™ï¼‰';
              list.appendChild(li);
            }
          } catch (e) {
            console.error(e);
          }
        }
      });
    }

    function addFavorite(){
      const code=newFavorite.value.trim();
      if(!code.match(/^\d+$/)){alert('è«‹è¼¸å…¥æœ‰æ•ˆä»£ç¢¼');return;}
      favRef.update({[code]:true});
      newFavorite.value='';
      loadFavorites();
    }

    const chartCtx=document.getElementById('chart').getContext('2d');
    let stockChart=null;
    async function loadStock(){
      const symbol=symbolInput.value.trim();
      if(!symbol.match(/^\d+$/)){alert('è«‹è¼¸å…¥æœ‰æ•ˆä»£ç¢¼');return;}
      try{
        const res = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&stockNo=${symbol}`);
        const data = await res.json();
        console.log("TWSE å›å‚³ï¼š", data);

        if (data.stat !== "OK" || !data.data) {
          alert('æŸ¥è©¢å¤±æ•—ï¼ˆä»£ç¢¼éŒ¯èª¤æˆ–æš«ç„¡è³‡æ–™ï¼‰');
          return;
        }
        const labels = data.data.map(row => {
          const parts = row[0].split('/');
          const year = parseInt(parts[0]) + 1911;
          return `${year}-${parts[1]}-${parts[2]}`;
        });
        const prices = data.data.map(row => parseFloat(row[6].replace(/,/g, '')));
        if (stockChart) stockChart.destroy();
        stockChart = new Chart(chartCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: `${symbol} æ”¶ç›¤åƒ¹`,
              data: prices,
              borderColor: 'rgba(240,165,0,0.9)',
              backgroundColor: 'rgba(240,165,0,0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: getComputedStyle(document.body).color } }
            },
            scales: {
              x: { ticks: { color: getComputedStyle(document.body).color } },
              y: { ticks: { color: getComputedStyle(document.body).color } }
            }
          }
        });
      } catch (e) {
        console.error(e);
      }
    }

async function addShow() {
  const url = document.getElementById("showUrlInput").value.trim();
  if (!url) return alert("è«‹è¼¸å…¥ç¯€ç›®ç¶²å€");

  const dramaMatch = url.match(/drama\/(\d+)/);
  if (!dramaMatch) return alert("ç¶²å€æ ¼å¼ä¸æ­£ç¢º");
  const dramaId = dramaMatch[1];

  try {
    const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(`https://www.movieffm.net/drama/${dramaId}/`)}`;
    const response = await fetch(proxyUrl);

    if (!response.ok) throw new Error(`Proxy è«‹æ±‚å¤±æ•—ï¼š${response.status}`);
    const html = await response.text();

    let title = "æœªçŸ¥ç¯€ç›®";
    const titleMatch = html.match(/<title>(.*?)<\/title>/i);
    if (titleMatch) {
      title = titleMatch[1].replace(/- MovieFFM.*/i, "").trim();
    }

    let status = "";
    const statusMatch = html.match(/ç‹€æ…‹ï¼š<span>(.*?)<\/span>/i);
    if (statusMatch) {
      status = statusMatch[1].trim();
    }

    let updateTime = "";
    const timeMatch = html.match(/æ›´æ–°æ™‚é–“ï¼š<span>(.*?)<\/span>/i);
    if (timeMatch) {
      updateTime = timeMatch[1].trim();
    }

    const user = localStorage.getItem("currentUser");
    if (!user) return alert("è«‹å…ˆç™»å…¥");

    const showRef = db.ref(`users/${user}/shows`);
    const key = btoa(url); 

    await showRef.child(key).set({
      url,
      title,
      status,
      updateTime,
      addedAt: Date.now(),
    });

    document.getElementById("showUrlInput").value = "";
    loadShows();

  } catch (err) {
    console.error("addShow error:", err);
    alert("âš ï¸ ç„¡æ³•è®€å–ç¯€ç›®å…§å®¹ï¼ˆå¯èƒ½è¢«ç¶²ç«™é˜²è­·æ“‹ä¸‹ï¼‰ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æ‰‹å‹•è¼¸å…¥ç¯€ç›®åç¨±ã€‚");
  }
}




    function loadShows(shouldUpdate = false) {
  if (!showRef) return;
  const list = document.getElementById("showList");

  showRef.once("value").then((snap) => {
    const data = snap.val() || {};
    list.innerHTML = "";
    const keys = Object.keys(data);
    if (keys.length === 0) {
      list.innerHTML = "<li>å°šæœªè¿½è¹¤ä»»ä½•ç¯€ç›®</li>";
      return;
    }

    const items = Object.entries(data).sort((a, b) => (b[1].addedAt || 0) - (a[1].addedAt || 0));
    items.forEach(([k, s]) => {
      const li = document.createElement("li");
      li.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="max-width:78%;">
            <a href="${s.url}" target="_blank" style="font-weight:bold; color:#f0a500;">${s.title || s.url}</a><br>
            <span class="small-note">ç‹€æ…‹ï¼š${s.status || '-'}ï½œæ›´æ–°æ™‚é–“ï¼š${s.updateTime || '-'}</span>
          </div>
          <div>
            <button onclick="removeShow('${btoa(s.url)}')">ğŸ—‘ï¸ åˆªé™¤</button>
          </div>
        </div>`;
      list.appendChild(li);

      if (shouldUpdate) updateShowInfo(s.url, k);
    });
  });
}


async function updateShowInfo(url, key, shouldNotifyLine = false) {
  const dramaMatch = url.match(/drama\/(\d+)/);
  if (!dramaMatch) return;

  const dramaId = dramaMatch[1];

  try {
    const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(`https://www.movieffm.net/drama/${dramaId}/`)}`;
    const response = await fetch(proxyUrl);
    if (!response.ok) throw new Error(`Proxy è«‹æ±‚å¤±æ•—ï¼š${response.status}`);

    const html = await response.text();

    const statusMatch = html.match(/ç‹€æ…‹ï¼š<span>(.*?)<\/span>/i);
    const newStatus = statusMatch ? statusMatch[1].trim() : "æœªçŸ¥";

    const timeMatch = html.match(/æ›´æ–°æ™‚é–“ï¼š<span>(.*?)<\/span>/i);
    const newUpdateTime = timeMatch ? timeMatch[1].trim() : "";

    const user = localStorage.getItem("currentUser");
    if (!user) return;

    const showRef = db.ref(`users/${user}/shows/${key}`);
    const oldSnap = await showRef.once("value");
    const oldData = oldSnap.val() || {};
    let hasNew = false;

    if (oldData.status !== newStatus || oldData.updateTime !== newUpdateTime) {
      hasNew = true;
      await showRef.update({
        status: newStatus,
        updateTime: newUpdateTime,
        lastChecked: Date.now()
      });

      if (shouldNotifyLine) {
        pushLine(`ğŸ“º ç¯€ç›®æ›´æ–°å›‰ï¼\n${oldData.title || url}\næ–°ç‹€æ…‹ï¼š${newStatus}\næ›´æ–°æ™‚é–“ï¼š${newUpdateTime}`);
      }
    }

    const list = document.getElementById("showList");
    const li = [...list.querySelectorAll("li")].find(el => el.innerHTML.includes(url));
    if (li) {
      const titleTag = li.querySelector("a");
      if (titleTag) {
        if (hasNew) {
          titleTag.innerHTML = `ğŸ†•æœ‰æ–°é›†æ•¸ğŸ˜ğŸ˜ ${titleTag.textContent.replace(/^ğŸ†•\s*/, '')}`;
        } else {
          titleTag.innerHTML = titleTag.textContent.replace(/^ğŸ†•\s*/, '');
        }
      }
      const note = li.querySelector(".small-note");
      if (note) note.textContent = `ç‹€æ…‹ï¼š${newStatus}ï½œæ›´æ–°æ™‚é–“ï¼š${newUpdateTime}`;
    }

  } catch (err) {
    console.warn("æ›´æ–°ç¯€ç›®è³‡è¨Šå¤±æ•—ï¼š", url, err);
  }
}




    function removeShow(key) {
  if (!showRef) return;
  if (confirm("ç¢ºå®šè¦ç§»é™¤é€™å€‹ç¯€ç›®å—ï¼Ÿ")) {
    showRef.child(key).remove();
  }
}

    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'addShowBtn') {
        addShow();
      }
    });

    window.addEventListener('load', () => {
      const currentUser = localStorage.getItem('currentUser');

      if (currentUser) {
        userRef = db.ref(`users/${currentUser}/records`);
        pfRef = db.ref(`users/${currentUser}/portfolio`);
        document.getElementById('roleSelect').value = currentUser;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        initForUser(currentUser);
      } else {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
      }

      const today = new Date().toISOString().split('T')[0];
      if (document.getElementById('recordDate')) document.getElementById('recordDate').value = today;

      if (currentUser) {
        const savedSalary = localStorage.getItem(`${currentUser}_salary`);
        if (savedSalary && !salaryInput.value) {
          salaryInput.value = savedSalary;
          salaryStatus.textContent = `å·²è¼‰å…¥ä¸Šæ¬¡è¨­å®šï¼š${savedSalary} å…ƒ`;
        }

        const limits = JSON.parse(localStorage.getItem(`${currentUser}_limits`) || '{}');
        for (const key of ['food', 'transport', 'entertainment', 'other']) {
          if (limits[key]) {
            const el = document.getElementById(`limit_${key}`);
            if (el) el.value = limits[key];
          }
        }
      }

      loadFavorites();
      if (symbolInput.value && symbolInput.value.trim().length>0) {
        setTimeout(()=>{ 
          try { loadStock(); } catch(e){ console.error(e); }
        }, 300);
      }

      const savedTheme = localStorage.getItem('themeMode');
      if (savedTheme) setTheme(savedTheme);

      console.log("âœ… åˆå§‹åŒ–å®Œæˆ");
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log("âœ… Service Worker è¨»å†Šå®Œæˆ"))
        .catch(err => console.error("âŒ SW è¨»å†Šå¤±æ•—", err));
    }
  
    async function updateFamilyRank() {
      try {
        const users = ["mom","debby","jason"];
        const names = { mom: "åª½åª½", dad: "çˆ¸çˆ¸", debby: "å¦¹å¦¹", jason: "Jason" };
        const now = Date.now();
        const day7 = 7 * 24 * 3600 * 1000;
        const windowStart = now - day7;
        const results = [];
        for (const u of users) {
          const snap = await db.ref(`users/${u}/records`).once('value');
          const arr = Object.values(snap.val() || {});
          const recent = arr.filter(r => (r.timestamp || 0) >= windowStart);
          const total = recent.reduce((s,r)=>s + (parseFloat(r.amount)||0), 0);
          results.push({ user: u, total, count: recent.length });
        }
        let mostSpend = results[0], mostFrugal = results[0];
        for (const r of results) {
          if (r.total > mostSpend.total) mostSpend = r;
          if (r.total < mostFrugal.total) mostFrugal = r;
        }
        const allZero = results.every(r => r.total === 0);
        const rankEl = document.getElementById('familyRank');
        if (!rankEl) return;
        if (allZero) {
          rankEl.textContent = 'ğŸ† æ¯é€±æ’è¡Œï¼šå°šç„¡æ”¯å‡ºç´€éŒ„';
        } else {
          rankEl.textContent = `ğŸ† æ¯é€±æ’è¡Œï¼šğŸ’°èŠ±æœ€å¤š ${names[mostSpend.user]} ï½œğŸ’¡æœ€ç¯€çœ ${names[mostFrugal.user]}`;
        }
      } catch (e) {
        console.error("updateFamilyRank error", e);
      }
    }

    function scheduleDailyMidnightUpdate() {
      const now = new Date();
      const next = new Date();
      next.setHours(24,0,5,0); 
      const ms = next.getTime() - now.getTime();
      setTimeout(() => {
        updateFamilyRank();
        setInterval(updateFamilyRank, 24 * 3600 * 1000);
      }, ms);
    }

    function populateYearMonthSelectors() {
      const yEl = document.getElementById('filterYear');
      const mEl = document.getElementById('filterMonth');
      if (!yEl || !mEl) return;
      const now = new Date();
      const thisYear = now.getFullYear();
      yEl.innerHTML = '<option value="all">å…¨éƒ¨</option>';
      for (let y=thisYear; y>=thisYear-4; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yEl.appendChild(opt);
      }
      mEl.innerHTML = '<option value="all">å…¨éƒ¨</option>';
      for (let i=1;i<=12;i++) {
        const val = String(i).padStart(2,'0');
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        mEl.appendChild(opt);
      }
      yEl.value = String(thisYear);
      mEl.value = String(now.getMonth()+1).padStart(2,'0');
    }

    async function filterRecords() {
      const y = document.getElementById('filterYear').value;
      const m = document.getElementById('filterMonth').value;
      const list = document.getElementById('recordList');
      if (!userRef) { list.innerHTML = '<li>è«‹å…ˆç™»å…¥</li>'; return; }
      if (y === 'all' && m === 'all') {
        loadRecentRecords();
        return;
      }
      const start = (y==='all'?'0000':y) + '-' + (m==='all'?'00':m);
      const end = (y==='all'?'9999':y) + '-' + (m==='all'?'12':m);
      try {
        const snap = await userRef.orderByChild('date').once('value');
        const data = snap.val() || {};
        const arr = Object.entries(data).map(([k,v]) => ({ key:k, ...v })).sort((a,b)=>b.timestamp - a.timestamp);
        const filtered = arr.filter(r => {
          if (y === 'all' && m !== 'all') {
            return r.date && r.date.slice(5,7) === m;
          } else if (y !== 'all' && m === 'all') {
            return r.date && r.date.startsWith(y+'-');
          } else if (y !== 'all' && m !== 'all') {
            return r.date && r.date.startsWith(y+'-'+m);
          }
          return true;
        });
        list.innerHTML = '';
        if (filtered.length === 0) {
          list.innerHTML = '<li>æ­¤æœˆä»½ç„¡ç´€éŒ„</li>';
          return;
        }
        for (const r of filtered) {
          const li = document.createElement('li');
          li.innerHTML = `
            <div style="display:flex; justify-content: space-between; align-items: center;">
              <span>${r.date} - ${r.role} - ${r.category} - ${r.amount} å…ƒ - ${r.description || ''}</span>
              <button onclick="deleteRecord('${r.key}')">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>`;
          list.appendChild(li);
        }
      } catch (e) {
        console.error('filterRecords error', e);
        list.innerHTML = '<li>æŸ¥è©¢å¤±æ•—</li>';
      }
    }

    function resetRecordFilter() {
      populateYearMonthSelectors();
      loadRecentRecords();
    }

    (function initExtraFeatures() {
      try {
        populateYearMonthSelectors();
        updateFamilyRank();
        scheduleDailyMidnightUpdate();

        window.addEventListener('load', () => {
          setTimeout(()=>{
            try { filterRecords(); } catch(e){ console.warn(e); }
          }, 500);
        });
      } catch (e) { console.error(e); }
    })();

function notifyUpdate(title, data) {
  try {
    let badge = document.getElementById('showUpdateBadge');
    if (!badge) {
      badge = document.createElement('div');
      badge.id = 'showUpdateBadge';
      badge.style.position = 'fixed';
      badge.style.top = '15px';
      badge.style.right = '110px';
      badge.style.background = '#ff4757';
      badge.style.color = '#fff';
      badge.style.padding = '6px 10px';
      badge.style.borderRadius = '18px';
      badge.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
      badge.style.zIndex = 9999;
      badge.style.fontWeight = '700';
      document.body.appendChild(badge);
    }
    badge.textContent = 'ğŸ†• ç¯€ç›®æ›´æ–°ï¼š' + (title || 'æ–°ç¯€ç›®');
    setTimeout(()=>{ try { badge.style.opacity = '0.95'; } catch(e){} }, 100);
    setTimeout(()=>{ try { badge.style.opacity = '0.6'; } catch(e){} }, 4000);
    setTimeout(()=>{ try { badge.remove(); } catch(e){} }, 12000);

    if (Notification && Notification.permission === 'granted') {
      new Notification('ğŸ†• ç¯€ç›®æ›´æ–°', { body: title });
    } else if (Notification && Notification.permission !== 'denied') {
      Notification.requestPermission().then(p => {
        if (p === 'granted') new Notification('ğŸ†• ç¯€ç›®æ›´æ–°', { body: title });
      });
    }
  } catch(e){ console.error('notifyUpdate error', e); }
}

async function loadYTTrending() {
  const grid = document.getElementById('ytTrendingGrid');
  if (!grid) return;
  grid.innerHTML = '<div class="card">è¼‰å…¥ä¸­...</div>';
  try {
    const proxy = 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent('https://charts.youtube.com/charts/TrendingTrailers/tw');
    const resp = await fetch(proxy);
    const html = await resp.text();
    const matches = [...html.matchAll(/"videoId":"(.*?)".*?"title":"(.*?)"/g)];
    grid.innerHTML = '';
    matches.slice(0,12).forEach((m, idx) => {
      const id = m[1];
      let title = m[2];
      try { title = JSON.parse('"' + title + '"'); } catch(e){}
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `<img src="https://img.youtube.com/vi/${id}/0.jpg" style="width:100%;border-radius:6px;cursor:pointer" onclick="window.open('https://www.youtube.com/watch?v=${id}','_blank')"><div style="margin-top:6px;font-weight:700">${title}</div>`;
      grid.appendChild(div);
    });
  } catch (e) {
    console.error('loadYTTrending error', e);
    grid.innerHTML = '<div class="card">ç„¡æ³•è¼‰å…¥ç†±é–€å½±ç‰‡ï¼ˆproxy å¯èƒ½ä¸ç©©å®šï¼‰</div>';
  }
}

const musicRefRoot = db.ref('family/musicWall');
async function addMusicTrack() {
  const title = document.getElementById('musicInputTitle').value.trim();
  const embed = document.getElementById('musicInputEmbed').value.trim();
  const owner = document.getElementById('musicOwner').value;
  if (!embed) return alert('è«‹è¼¸å…¥ YouTube å½±ç‰‡ ID æˆ– Spotify embed URL');
  let id = embed;
  const ytMatch = embed.match(/(?:v=|youtu\.be\/|\/embed\/)([A-Za-z0-9_-]{6,})/);
  if (ytMatch) id = ytMatch[1];
  const track = { title: title || embed, embed: embed, youtubeId: ytMatch ? id : null, owner, addedAt: Date.now() };
  musicRefRoot.push(track);
  document.getElementById('musicInputTitle').value = '';
  document.getElementById('musicInputEmbed').value = '';
  loadMusicWall();
}

async function loadMusicWall() {
  const grid = document.getElementById('musicWallGrid');
  if (!grid) return;
  grid.innerHTML = '<div class="card">è¼‰å…¥ä¸­...</div>';
  const snap = await musicRefRoot.orderByChild('addedAt').once('value');
  const data = snap.val() || {};
  grid.innerHTML = '';
  const items = Object.entries(data).sort((a,b)=>b[1].addedAt - a[1].addedAt);
  if (items.length === 0) { grid.innerHTML = '<div class="card">ç›®å‰æ²’æœ‰æ›²ç›®</div>'; return; }
  for (const [k, t] of items) {
    const card = document.createElement('div');
    card.className = 'card';
    let iframeHTML = '';
    if (t.youtubeId) {
      iframeHTML = `<iframe width="100%" height="160" src="https://www.youtube.com/embed/${t.youtubeId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    } else if (t.embed && t.embed.includes('spotify')) {
      const src = t.embed.includes('embed') ? t.embed : t.embed.replace('open.spotify.com','open.spotify.com/embed');
      iframeHTML = `<iframe src="${src}" width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;
    } else if (t.embed && t.embed.startsWith('http')) {
      iframeHTML = `<iframe src="${t.embed}" width="100%" height="120" frameborder="0"></iframe>`;
    } else {
      iframeHTML = `<div class="small-note">ç„¡æ³•è§£æçš„åµŒå…¥å…§å®¹ï¼š${t.embed}</div>`;
    }
    card.innerHTML = `<div style="font-weight:700">${t.title} <span style="font-weight:600;color:#888">(${t.owner})</span></div>
                      ${iframeHTML}
                      <div style="margin-top:6px;"><input placeholder="ç•™è¨€..." id="c_${k}" style="width:70%"><button onclick="postMusicComment('${k}')">ç•™è¨€</button></div>
                      <div id="comments_${k}" style="margin-top:8px;"></div>`;
    grid.appendChild(card);
    loadMusicComments(k);
  }
}
    
setInterval(() => {
  console.log("â° æ¯å°æ™‚è‡ªå‹•æª¢æŸ¥ç¯€ç›®æ›´æ–°ä¸­...");
  const user = localStorage.getItem("currentUser");
  if (!user) return;

  const showRef = firebase.database().ref(`users/${user}/shows`);
  showRef.once("value").then(snap => {
    const data = snap.val() || {};
    Object.entries(data).forEach(([key, show]) => {
      updateShowInfo(show.url, key, true);
    });
  });
}, 3600 * 1000); 

async function postMusicComment(key) {
  const el = document.getElementById('c_' + key);
  if (!el) return;
  const text = el.value.trim();
  if (!text) return alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹');
  const cur = localStorage.getItem('currentUser') || 'guest';
  await musicRefRoot.child(key).child('comments').push({ user: cur, text, time: Date.now() });
  el.value = '';
  loadMusicComments(key);
}
// è‡ªå‹•å°‡ç•¶å‰çš„ç¸½æç›Š A é»ç´€éŒ„åˆ°è³‡æ–™åº«ï¼Œä¾›å¿«ç…§åˆ†æä½¿ç”¨
function syncFamilyProfitToSnapshot() {
  const user = localStorage.getItem("currentUser");
  const profitText = document.getElementById("todayTotalProfit").textContent;
  const profit = parseFloat(profitText);
  if (!user || isNaN(profit)) return;

  const today = new Date().toISOString().split("T")[0];

  // 1. ç´€éŒ„æ¯æ—¥æ­·å²ï¼Œç”¨ä¾†ç®—ã€Œä»Šå¹´è³ºæœ€å¤š/æœ€æ…˜æ—¥ã€
  firebase.database().ref(`family/investSnapshot/${user}/${today}`).set({
    profit: profit,
    time: Date.now()
  });

  // 2. æ›´æ–°ç•¶å‰ç¾å€¼ï¼ˆä¾› calculateNetWorth è®€å–ï¼‰
  firebase.database().ref(`family/currentNetWorth/${user}`).set({
    value: profit,
    time: Date.now()
  });
}

// æ¯ 1 åˆ†é˜è‡ªå‹•è·‘ä¸€æ¬¡ç´€éŒ„ï¼Œç¢ºä¿è³‡æ–™æ˜¯æœ€æ–°çš„
setInterval(syncFamilyProfitToSnapshot, 60000);

// ç¶²é é–‹å•Ÿæ™‚ä¹Ÿç«‹åˆ»åŸ·è¡Œä¸€æ¬¡è¨ˆç®—èˆ‡åˆ†æ
window.addEventListener("load", () => {
    setTimeout(() => {
        calculateNetWorth(); // ä½ çš„æª”æ¡ˆæœ«ç«¯æœ‰é€™å€‹å‡½å¼
        loadAnnualReview();  // ä½ çš„æª”æ¡ˆæœ«ç«¯æœ‰é€™å€‹å‡½å¼
    }, 2000); // å»¶é²å…©ç§’ç­‰æ•¸æ“šæŠ“å®Œ
});
async function loadMusicComments(key) {
  const container = document.getElementById('comments_' + key);
  if (!container) return;
  container.innerHTML = 'è¼‰å…¥ç•™è¨€...';
  const snap = await musicRefRoot.child(key).child('comments').once('value');
  const data = snap.val() || {};
  container.innerHTML = '';
  const arr = Object.entries(data).map(([k,v])=>({k,...v})).sort((a,b)=>b.time - a.time);
  for (const c of arr) {
    const d = new Date(c.time).toLocaleString();
    const div = document.createElement('div');
    div.style.borderTop = '1px solid #eee'; div.style.paddingTop = '6px'; div.innerHTML = `<b>${c.user}</b>ï¼š${c.text} <span style="color:#777">(${d})</span>`;
    container.appendChild(div);
  }
}

try { loadYTTrending(); } catch(e) {}
try { loadMusicWall(); } catch(e) {}

</script>

<script>
async function checkInactivity() {
  const dayMs = 86400000;
  const now = Date.now();
  const users = ['mom','jason'];
  const names = {mom:'åª½åª½',jason:'Jason'};

  let alertHTML = "";

  for (const u of users) {
    const userRef = firebase.database().ref("users/" + u);

    // å–å¾—å»¶å¾Œæé†’æ™‚é–“
    const delaySnap = await userRef.child("inactivityDelayUntil").once("value");
    const delayUntil = delaySnap.exists() ? delaySnap.val() : 0;

    // âœ è‹¥æœ‰å»¶å¾Œï¼Œä¸”é‚„æ²’åˆ°æ™‚é–“ â†’ ä¸é¡¯ç¤ºã€ä¸æ¨æ’­
    if (now < delayUntil) continue;

    // å–å¾—æœ€å¾Œè¨˜å¸³æ™‚é–“
    const snap = await userRef.child("records")
      .orderByChild("timestamp").limitToLast(1).once('value');
    const val = snap.val();
    let lastTs = 0;

    if (val) lastTs = Object.values(val)[0].timestamp || 0;

    if (!lastTs) {
      alertHTML += `
      <div class='warn'>
        ${names[u]} å°šæœªè¨˜å¸³ï¼
        <button onclick="delayInactivity('${u}')">æˆ‘é€™å¹¾å¤©éƒ½æ²’èŠ±éŒ¢ï¼</button>
      </div>`;
      continue;
    }

    const days = Math.floor((now - lastTs) / dayMs);
    const dstr = new Date(lastTs - new Date().getTimezoneOffset()*60000)
      .toISOString().slice(0,10);

    if (days >= 2) {
      alertHTML += `
      <div class='warn'>
        ${names[u]} ä¸Šæ¬¡è¨˜å¸³ ${dstr} å·²è¶…é ${days} å¤©æœªè¨˜å¸³!! è«‹æ³¨æ„
        <button onclick="delayInactivity('${u}')">æˆ‘é€™å¹¾å¤©éƒ½æ²’èŠ±éŒ¢ï¼</button>
      </div>`;

      // âœ” æ¨æ’­é€šçŸ¥ï¼ˆä½ çš„èˆŠç‰ˆæœ¬åŠŸèƒ½ï¼‰
      if (Notification.permission === 'granted') {
        new Notification("è¨˜å¸³æé†’", {
          body: `${names[u]} å·² ${days} å¤©æœªè¨˜å¸³`
        });
      }
    }
  }

  const target = document.getElementById("inactivityZone");
  if (target) target.innerHTML = alertHTML;
}

async function pushLine(msg) {
  return fetch("https://api.line.me/v2/bot/message/push",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer IAVeviy3IfegCOxMwNV7CNLDz2wF+V7iDC8sUVTCtqtsxiYAwbIJGJ12wfhcOpxFJYv/NTBUutv609eMgBbRmcdzZPuKnhcUuq4Dhreq9NJniDPpU3DxltVbN6suMHQG/4HnJrt9IsDYcPT32y88bAdB04t89/1O/w1cDnyilFU="
    },
    body:JSON.stringify({
      to:"U11bb1cee1c5e4630a87fd2df11bad0c1",
      messages:[{type:"text",text:msg}]
    })
  });
}

function syncSnapshotPortfolio() {
  const src = document.querySelectorAll('#portfolioList li');
  const dest = document.getElementById('snapshotPortfolioList');
  if (!dest) return;

  dest.innerHTML = '';
  src.forEach(li => dest.appendChild(li.cloneNode(true)));

  if (!src.length) {
    dest.innerHTML = '<li>å°šç„¡è³‡æ–™</li>';
  }
}

// åœ¨æŠ•è³‡çµ„åˆæ›´æ–°å¾ŒåŒæ­¥
const _renderPortfolio = window.renderPortfolio;
if (_renderPortfolio) {
  window.renderPortfolio = function () {
    _renderPortfolio();
    syncSnapshotPortfolio();
  };
}
window.notifyEpisodeUpdate = async function(showName,newEp){
  const msg = `ğŸ“º ä½ è¿½çš„ ${showName} æ›´æ–°åˆ°ç¬¬ ${newEp} é›†ï¼`;
  await pushLine(msg);
};
window.addEventListener("load", () => {
  loadBoard();
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    // å¦‚æœæœ‰å­˜éä½¿ç”¨è€…ï¼Œç›´æ¥é¡¯ç¤ºä¸»ç•«é¢ä¸¦åˆå§‹åŒ–
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    initForUser(savedUser);
  }
});
window.addEventListener("load", ()=>{
  if (Notification.permission !== 'granted'){
    Notification.requestPermission();
  }
  checkInactivity();
});
</script>

<div id="inactivityZone" style="padding:10px;color:#d00;"></div>


<script>
/* --- Weather & FX control (lightweight) --- */
const weatherScenes = ['sunny','cloudy','night','rain','storm'];
const fxScenes = ['clouds','stars','meteors','particles','fireworks'];

function clearWeatherLayers() {
  const bg = document.getElementById('weather-bg');
  if (!bg) return;
  bg.innerHTML = '';
  bg.className = '';
  // remove overlay if exists
  const ov = document.getElementById('weather-overlay');
  if (ov) ov.remove();
}

function applyWeather(scene) {
  clearWeatherLayers();
  const bg = document.getElementById('weather-bg');
  if (!bg) return;
  const overlay = document.createElement('div');
  overlay.id = 'weather-overlay';
  document.body.appendChild(overlay);

  switch(scene) {
    case 'sunny':
      bg.classList.add('w-sunny');
      overlay.style.opacity = '0';
      break;
    case 'cloudy':
      bg.classList.add('w-cloudy');
      overlay.style.opacity = '0.0';
      // add subtle cloud pseudo via fx-clouds but light
      const c = document.createElement('div');
      c.className = 'fx-clouds';
      const cl1 = document.createElement('div'); cl1.className='cloud';
      const cl2 = document.createElement('div'); cl2.className='cloud c2';
      c.appendChild(cl1); c.appendChild(cl2);
      bg.appendChild(c);
      break;
    case 'night':
      bg.classList.add('w-night');
      overlay.style.opacity = '0';
      break;
    case 'rain':
      bg.classList.add('w-cloudy');
      const rain = document.createElement('div'); rain.className='rain-layer';
      bg.appendChild(rain);
      overlay.style.opacity = '0.15';
      break;
    case 'storm':
      bg.classList.add('w-cloudy');
      const rain2 = document.createElement('div'); rain2.className='rain-layer';
      bg.appendChild(rain2);
      const flash = document.createElement('div'); flash.className='lightning-flash';
      bg.appendChild(flash);
      overlay.style.opacity = '0.22';
      break;
    default:
      bg.classList.add('w-sunny');
      overlay.style.opacity = '0';
      break;
  }
}

/* pick random weather (button) */
function randomWeather() {
  const pick = weatherScenes[Math.floor(Math.random()*weatherScenes.length)];
  applyWeather(pick);
  // set theme classes for readability if needed
  if (pick === 'night') setTheme('night'); else if (pick==='cloudy' || pick==='rain' || pick==='storm') setTheme('day'); else setTheme('day');
}

/* FX handling */
function clearFX() {
  // remove fx containers inside weather-bg
  const bg = document.getElementById('weather-bg');
  if (!bg) return;
  const nodes = bg.querySelectorAll('.fx-clouds, .fx-stars, .fx-meteors, .fx-particles, .fx-fireworks');
  nodes.forEach(n => n.remove());
}

function applyFX(scene) {
  clearFX();
  const bg = document.getElementById('weather-bg');
  if (!bg) return;
  switch(scene) {
    case 'clouds':
      const cwrap = document.createElement('div'); cwrap.className='fx-clouds';
      const c1 = document.createElement('div'); c1.className='cloud';
      const c2 = document.createElement('div'); c2.className='cloud c2';
      cwrap.appendChild(c1); cwrap.appendChild(c2);
      bg.appendChild(cwrap);
      break;
    case 'stars':
      const s = document.createElement('div'); s.className='fx-stars';
      bg.appendChild(s);
      break;
    case 'meteors':
      const mwrap = document.createElement('div'); mwrap.className='fx-meteors';
      for (let i=0;i<3;i++){
        const met = document.createElement('div'); met.className='meteor';
        met.style.left = (10 + i*25) + 'vw';
        met.style.top = (-10 + i*10) + 'vh';
        met.style.animationDelay = (i*0.6) + 's';
        mwrap.appendChild(met);
      }
      bg.appendChild(mwrap);
      break;
    case 'particles':
      const pw = document.createElement('div'); pw.className='fx-particles';
      for (let i=0;i<10;i++){
        const p = document.createElement('div'); p.className='p';
        p.style.left = (Math.random()*90)+'vw';
        p.style.top = (Math.random()*80)+'vh';
        p.style.animationDuration = (6 + Math.random()*6)+'s';
        pw.appendChild(p);
      }
      bg.appendChild(pw);
      break;
    case 'fireworks':
      const fw = document.createElement('div'); fw.className='fx-fireworks';
      for (let i=0;i<6;i++){
        const b = document.createElement('div'); b.className='burst';
        b.style.left = (20 + i*10) + 'vw';
        b.style.top = (20 + (i%2)*10) + 'vh';
        b.style.animationDelay = (i*0.2) + 's';
        fw.appendChild(b);
      }
      bg.appendChild(fw);
      break;
    default:
      break;
  }
}

/* pick random FX */
function randomFX() {
  const pick = fxScenes[Math.floor(Math.random()*fxScenes.length)];
  applyFX(pick);
}

/* ensure buttons show current selection briefly */
document.addEventListener('DOMContentLoaded', ()=> {
  // preserve previous theme
  const saved = localStorage.getItem('themeMode') || 'day';
  setTheme(saved);
  // initialize with sunny
  applyWeather('sunny');
});

// ===== è‡ªå‹•åŒæ­¥ family æŒè‚¡ç¸½æç›Š â†’ è³‡ç”¢å¿«ç…§ï¼ˆæœ€çµ‚ç‰ˆï¼‰ =====
function syncFamilyProfitToSnapshot() {
  const user = localStorage.getItem("currentUser");
  const profitText = document.getElementById("todayTotalProfit").textContent;
  const profit = parseFloat(profitText);
  if (!user || isNaN(profit)) return;

  const today = new Date().toISOString().split("T")[0];
  // è¨˜éŒ„æ¯æ—¥æç›Šåˆ° Firebaseï¼Œä¾›ã€Œè³ºæœ€å¤š/æœ€æ…˜æ—¥ã€è¨ˆç®—
  firebase.database().ref(`family/investSnapshot/${user}/${today}`).set({
    profit: profit,
    time: Date.now()
  });
}

// æ¯ 30 ç§’å˜—è©¦åŒæ­¥ä¸€æ¬¡ï¼ˆä¸å½±éŸ¿æ•ˆèƒ½ï¼‰
setInterval(syncFamilyProfitToSnapshot, 30000);

// è³‡ç”¢å¿«ç…§è®€å– family è³‡æ–™
function calculateNetWorth() {
  const user = localStorage.getItem("currentUser");
  firebase.database().ref(`family/currentNetWorth/${user}`).on("value", snap => {
    if (!snap.exists()) return;
    document.getElementById("currentNetWorth").textContent =
      snap.val().value.toLocaleString();
  });
}

function loadAnnualReview() {
  const user = localStorage.getItem("currentUser");
  firebase.database().ref(`family/investSnapshot/${user}`).on("value", snap => {
    const data = snap.val();
    if (!data) return;

    const entries = Object.entries(data)
      .map(([d, v]) => [d, v.profit])
      .sort((a, b) => new Date(a[0]) - new Date(b[0]));

    const maxGain = entries.reduce((a, b) => b[1] > a[1] ? b : a);
    const maxLoss = entries.reduce((a, b) => b[1] < a[1] ? b : a);

    document.getElementById("maxGainDay").textContent =
      `${maxGain[0]} (+${maxGain[1].toLocaleString()})`;
    document.getElementById("maxLossDay").textContent =
      `${maxLoss[0]} (${maxLoss[1].toLocaleString()})`;

    updateChart(entries);
  });
}

