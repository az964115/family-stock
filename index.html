<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f0a500">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ·è±¬è±¬eç¶²ğŸ·</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 20px; max-width: 900px;
      background-color: #fdf6e3; color: #333;
      transition: background-color 0.4s, color 0.4s;
    }
    .container {
      background: #fff3e0; border-radius: 10px; padding: 20px;
      margin-bottom: 25px; box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    }
    button {
      cursor: pointer; padding: 8px 14px; font-size: 16px;
      border-radius: 5px; border: none; background-color: #f0a500; color: #fff;
      transition: 0.3s;
    }
    button:hover { background-color: #d88e00; }
    input, select, textarea {
      padding: 8px; font-size: 16px; border: 1px solid #ccc; 
      border-radius: 5px; width: 100%; box-sizing: border-box;
    }
    .flex-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
    .flex-grow { flex-grow: 1; min-width: 200px; }
    .stat-box {
      background: #fff7cc; padding: 15px; border-radius: 8px;
      margin-top: 10px; box-shadow: inset 0 0 6px #f0a500aa; font-weight: 600;
    }
    ul { list-style: none; padding: 0; background: #fff; border-radius: 6px; }
    ul li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    
    iframe { width: 100%; height: 500px; border: 2px solid #f0a500; border-radius: 10px; margin-top: 10px; }
    body.theme-night { background-color: #121212; color: #eee; }
    body.theme-night .container { background: #1e1e1e; color: #eee; }
    body.theme-night .stat-box { color: #333; }
    .chart-container { position: relative; height: 250px; width: 100%; margin-top: 15px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>

  <div id="loginSection" class="container" style="max-width:400px; margin: 40px auto;">
    <h2>ğŸ‘¤ ä½¿ç”¨è€…ç™»å…¥</h2>
    <select id="loginUser">
      <option value="mom">åª½åª½</option>
      <option value="dad">çˆ¸çˆ¸</option>
      <option value="debby">å¦¹å¦¹</option>
      <option value="jason">Jason</option>
    </select>
    <input type="password" id="loginPassword" placeholder="è¼¸å…¥å¯†ç¢¼" style="margin-top:10px;">
    <button onclick="login()" style="width:100%; margin-top:15px;">ç™»å…¥</button>
  </div>

  <div id="mainContent" style="display:none;">
    <div style="text-align: right; margin-bottom: 10px;">
      <button onclick="setTheme('day')">ğŸŒ ç™½å¤©</button>
      <button onclick="setTheme('night')">ğŸŒ™ é»‘å¤œ</button>
      <button onclick="logout()">ğŸšª ç™»å‡º</button>
    </div>

    <section class="container">
      <h2>ğŸ’° 2026 è³‡ç”¢å¿«ç…§</h2>
      <div class="stat-box">
        <p>ğŸ’° ç•¶å‰è³‡ç”¢ç¾å€¼ï¼š<span id="currentNetWorth" style="font-size:1.5em;color:#f0a500;">0</span> å…ƒ</p>
        <div class="flex-row">
          <div class="flex-grow">ğŸš€ ä»Šå¹´è³ºæœ€å¤šï¼š<br><small id="maxGainDay">è®€å–ä¸­...</small></div>
          <div class="flex-grow">ğŸ“‰ ä»Šå¹´æœ€æ…˜æ—¥ï¼š<br><small id="maxLossDay">è®€å–ä¸­...</small></div>
        </div>
      </div>
      <div class="chart-container"><canvas id="profitTrendChart"></canvas></div>
    </section>

    <section class="container">
      <h2>ğŸ’¼ æˆ‘çš„æŠ•è³‡çµ„åˆ</h2>
      <div class="flex-row">
        <input type="text" id="pfSymbol" placeholder="è‚¡è™Ÿ" style="flex:1">
        <input type="number" id="pfShares" placeholder="è‚¡æ•¸" style="flex:1">
        <input type="number" id="pfCost" placeholder="æˆæœ¬" style="flex:1">
        <button onclick="addPortfolio()">æ–°å¢</button>
      </div>
      <div style="margin: 10px 0;">
        ğŸ“ˆ æç›Šï¼š<span id="todayTotalProfit">0</span> å…ƒ
        <button onclick="updateTodayProfit()" style="font-size: 12px; padding: 4px 8px;">ğŸ”„ åˆ·æ–°åŒæ­¥</button>
      </div>
      <ul id="portfolioList"></ul>
    </section>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCGSq-8joudLdCEB954krl3diNqMQXmsxg",
      authDomain: "piggynet-93c33.firebaseapp.com",
      databaseURL: "https://piggynet-93c33-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "piggynet-93c33",
      storageBucket: "piggynet-93c33.appspot.com",
      messagingSenderId: "65171780729",
      appId: "1:65171780729:web:ce5f7272f25a75f43490a8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let profitChartInstance = null;

    async function login() {
      const user = document.getElementById('loginUser').value;
      const pass = document.getElementById('loginPassword').value.trim();
      const snap = await db.ref(`users/${user}/password`).get();
      const stored = snap.exists() ? snap.val() : "9527";
      if (pass === stored) { localStorage.setItem('currentUser', user); location.reload(); }
      else alert("å¯†ç¢¼éŒ¯èª¤");
    }

    function logout() { localStorage.removeItem('currentUser'); location.reload(); }

    window.onload = () => {
      const user = localStorage.getItem('currentUser');
      if (user) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        initApp(user);
      }
    };

    function initApp(user) {
      loadBoard();
      loadRecords(user);
      loadPortfolio(user);
      loadShows(user);
      loadAnnualReview(user);
    }

    function postMessage() {
      const msg = document.getElementById('boardInput').value;
      if (!msg) return;
      db.ref("family/board").push({ user: localStorage.getItem('currentUser'), msg, time: Date.now() });
      document.getElementById('boardInput').value = "";
    }

    function loadBoard() {
      db.ref("family/board").limitToLast(10).on("value", snap => {
        const box = document.getElementById("boardMessages");
        box.innerHTML = Object.values(snap.val() || {}).reverse().map(m => `<div><b>${m.user}</b>: ${m.msg}</div>`).join('');
      });
    }

    function addRecord() {
      const user = localStorage.getItem('currentUser');
      const amount = parseFloat(document.getElementById('amountInput').value);
      if (!amount) return;
      db.ref(`users/${user}/records`).push({
        amount, category: document.getElementById('categorySelect').value,
        description: document.getElementById('descriptionInput').value,
        date: new Date().toISOString().split('T')[0]
      }).then(() => { location.reload(); });
    }

    function loadRecords(user) {
      db.ref(`users/${user}/records`).limitToLast(5).once('value', snap => {
        const list = document.getElementById('recordList');
        list.innerHTML = Object.values(snap.val() || {}).reverse().map(r => `<li>${r.date} | ${r.amount}å…ƒ (${r.category})</li>`).join('');
      });
    }

    function addShow() {
      const user = localStorage.getItem('currentUser');
      const url = document.getElementById('showUrlInput').value.trim();
      if (!url) return;
      db.ref(`users/${user}/shows`).push({ url, time: Date.now() });
      document.getElementById('showUrlInput').value = "";
    }

    function loadShows(user) {
      db.ref(`users/${user}/shows`).on('value', snap => {
        const list = document.getElementById('showList');
        const data = snap.val() || {};
        list.innerHTML = Object.entries(data).map(([key, s]) => 
          `<li><a href="${s.url}" target="_blank">é»æˆ‘æŸ¥çœ‹ç¯€ç›®</a> <button onclick="db.ref('users/${user}/shows/${key}').remove()">ğŸ—‘ï¸</button></li>`
        ).join('');
      });
    }
    async function updateTodayProfit() {
      const user = localStorage.getItem('currentUser');
      const snap = await db.ref(`users/${user}/portfolio`).get();
      if (!snap.exists()) return;
      document.getElementById("todayTotalProfit").textContent = "æ›´æ–°ä¸­...";
      let totalP = 0, totalN = 0;
      for (const [code, info] of Object.entries(snap.val())) {
        try {
          const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&stockNo='+code)}`);
          const json = await res.json();
          const stock = JSON.parse(json.contents);
          const price = parseFloat(stock.data.pop()[6].replace(/,/g, ""));
          totalP += (price - info.cost) * info.shares;
          totalN += price * info.shares;
        } catch(e) {}
      }
      document.getElementById("todayTotalProfit").textContent = Math.round(totalP).toLocaleString();
      document.getElementById("currentNetWorth").textContent = Math.round(totalN).toLocaleString();
      db.ref(`family/investSnapshot/${user}/${new Date().toISOString().split('T')[0]}`).set({ profit: Math.round(totalP) });
      loadAnnualReview(user);
    }

    function loadPortfolio(user) {
      db.ref(`users/${user}/portfolio`).on('value', snap => {
        document.getElementById('portfolioList').innerHTML = Object.entries(snap.val() || {}).map(([c, i]) => `<li><b>${c}</b> | ${i.shares}è‚¡ | æˆæœ¬:${i.cost}</li>`).join('');
      });
    }

    function addPortfolio() {
      const user = localStorage.getItem('currentUser');
      const code = document.getElementById('pfSymbol').value;
      const shares = parseFloat(document.getElementById('pfShares').value);
      const cost = parseFloat(document.getElementById('pfCost').value);
      if(code && shares) db.ref(`users/${user}/portfolio/${code}`).set({ shares, cost });
    }

    function loadAnnualReview(user) {
      db.ref(`family/investSnapshot/${user}`).once("value", snap => {
        const entries = Object.entries(snap.val() || {}).map(([d,v])=>({date:d, profit:v.profit})).sort((a,b)=>new Date(a.date)-new Date(b.date));
        if(!entries.length) return;
        const max = entries.reduce((p,c)=>c.profit>p.profit?c:p);
        const min = entries.reduce((p,c)=>c.profit<p.profit?p:c);
        document.getElementById("maxGainDay").innerHTML = `${max.date}<br><span style="color:red;">$${max.profit}</span>`;
        document.getElementById("maxLossDay").innerHTML = `${min.date}<br><span style="color:green;">$${min.profit}</span>`;
        renderChart(entries);
      });
    }

    function renderChart(entries) {
      const ctx = document.getElementById('profitTrendChart').getContext('2d');
      if (profitChartInstance) profitChartInstance.destroy();
      profitChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: entries.slice(-7).map(e=>e.date.substring(5)),
          datasets: [{ label:'æç›Š', data: entries.slice(-7).map(e=>e.profit), borderColor:'#f0a500', fill:true }]
        },
        options: { responsive:true, maintainAspectRatio:false }
      });
    }

    function setTheme(mode) {
      document.body.className = 'theme-' + mode;
      localStorage.setItem('themeMode', mode);
    }
  </script>
</body>
</html>
